"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.promise");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.default = void 0;

var _stringify = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/json/stringify"));

var _promise = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/promise"));

var _keys = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/keys"));

var _stream = require("stream");

/**
 *
 */
function parseHeaders(hs) {
  const headers = {};

  for (const line of hs.split(/\n/)) {
    const [name, value] = line.split(/\s*:\s*/);
    headers[name.toLowerCase()] = value;
  }

  return headers;
}

async function processCanvasRequest(params, signedRequest, requestBody) {
  const settings = {
    client: signedRequest.client,
    method: params.method,
    data: requestBody
  };
  const paramHeaders = params.headers;

  if (paramHeaders) {
    settings.headers = {};

    for (const name of (0, _keys.default)(paramHeaders)) {
      if (name.toLowerCase() === 'content-type') {
        settings.contentType = paramHeaders[name];
      } else {
        settings.headers[name] = paramHeaders[name];
      }
    }
  }

  const data = await new _promise.default((resolve, reject) => {
    settings.success = resolve;
    settings.failure = reject;
    Sfdc.canvas.client.ajax(params.url, settings);
  });
  const headers = parseHeaders(data.responseHeaders);
  let responseBody = data.payload;

  if (typeof responseBody !== 'string') {
    responseBody = (0, _stringify.default)(responseBody);
  }

  return {
    statusCode: data.status,
    headers,
    body: responseBody
  };
}

function createRequest(signedRequest) {
  return params => {
    const buf = [];
    const stream = new _stream.Transform({
      transform(chunk, encoding, callback) {
        buf.push(typeof chunk === 'string' ? chunk : chunk.toString('utf8'));
        callback();
      },

      flush() {
        (async () => {
          const body = buf.join('');
          const response = await processCanvasRequest(params, signedRequest, body);
          stream.emit('response', response);
          stream.emit('complete', response);
          stream.push(response.body);
          stream.push(null);
        })();
      }

    });

    if (params.body) {
      stream.end(params.body);
    }

    return stream;
  };
}

var _default = {
  supported: typeof Sfdc === 'object' && typeof Sfdc.canvas !== 'undefined',
  createRequest
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9icm93c2VyL2NhbnZhcy50cyJdLCJuYW1lcyI6WyJwYXJzZUhlYWRlcnMiLCJocyIsImhlYWRlcnMiLCJsaW5lIiwic3BsaXQiLCJuYW1lIiwidmFsdWUiLCJ0b0xvd2VyQ2FzZSIsInByb2Nlc3NDYW52YXNSZXF1ZXN0IiwicGFyYW1zIiwic2lnbmVkUmVxdWVzdCIsInJlcXVlc3RCb2R5Iiwic2V0dGluZ3MiLCJjbGllbnQiLCJtZXRob2QiLCJkYXRhIiwicGFyYW1IZWFkZXJzIiwiY29udGVudFR5cGUiLCJyZXNvbHZlIiwicmVqZWN0Iiwic3VjY2VzcyIsImZhaWx1cmUiLCJTZmRjIiwiY2FudmFzIiwiYWpheCIsInVybCIsInJlc3BvbnNlSGVhZGVycyIsInJlc3BvbnNlQm9keSIsInBheWxvYWQiLCJzdGF0dXNDb2RlIiwic3RhdHVzIiwiYm9keSIsImNyZWF0ZVJlcXVlc3QiLCJidWYiLCJzdHJlYW0iLCJUcmFuc2Zvcm0iLCJ0cmFuc2Zvcm0iLCJjaHVuayIsImVuY29kaW5nIiwiY2FsbGJhY2siLCJwdXNoIiwidG9TdHJpbmciLCJmbHVzaCIsImpvaW4iLCJyZXNwb25zZSIsImVtaXQiLCJlbmQiLCJzdXBwb3J0ZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHQTs7QUFIQTtBQUNBO0FBQ0E7QUFZQSxTQUFTQSxZQUFULENBQXNCQyxFQUF0QixFQUFrQztBQUNoQyxRQUFNQyxPQUErQixHQUFHLEVBQXhDOztBQUNBLE9BQUssTUFBTUMsSUFBWCxJQUFtQkYsRUFBRSxDQUFDRyxLQUFILENBQVMsSUFBVCxDQUFuQixFQUFtQztBQUNqQyxVQUFNLENBQUNDLElBQUQsRUFBT0MsS0FBUCxJQUFnQkgsSUFBSSxDQUFDQyxLQUFMLENBQVcsU0FBWCxDQUF0QjtBQUNBRixJQUFBQSxPQUFPLENBQUNHLElBQUksQ0FBQ0UsV0FBTCxFQUFELENBQVAsR0FBOEJELEtBQTlCO0FBQ0Q7O0FBQ0QsU0FBT0osT0FB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O0FBbEIwQixLQUFkLENBQWY7O0FBb0JBLFFBQUkvQixNQUFNLENBQUNzQixJQUFYLEVBQWlCO0FBQ2ZHLE1BQUFBLE1BQU0sQ0FBQ1ksR0FBUCxDQUFXckMsTUFBTSxDQUFDc0IsSUFBbEI7QUFDRDs7QUFDRCxXQUFPRyxNQUFQO0FBQ0QsR0ExQkQ7QUEyQkQ7O2VBRWM7QUFDYmEsRUFBQUEsU0FBUyxFQUFFLE9BQU96QixJQUFQLEtBQWdCLFFBQWhCLElBQTRCLE9BQU9BLElBQUksQ0FBQ0MsTUFBWixLQUF1QixXQURqRDtBQUViUyxFQUFBQTtBQUZhLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqXG4gKi9cbmltcG9ydCB7IFRyYW5zZm9ybSB9IGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBIdHRwUmVxdWVzdCwgU2lnbmVkUmVxdWVzdE9iamVjdCB9IGZyb20gJy4uL3R5cGVzJztcblxuZGVjbGFyZSB2YXIgU2ZkYzogYW55O1xuXG50eXBlIENhbnZhc1Jlc3BvbnNlID0ge1xuICBzdGF0dXM6IHN0cmluZztcbiAgcmVzcG9uc2VIZWFkZXJzOiBzdHJpbmc7XG4gIHBheWxvYWQ6IGFueTtcbn07XG5cbmZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoczogc3RyaW5nKSB7XG4gIGNvbnN0IGhlYWRlcnM6IEh0dHBSZXF1ZXN0WydoZWFkZXJzJ10gPSB7fTtcbiAgZm9yIChjb25zdCBsaW5lIG9mIGhzLnNwbGl0KC9cXG4vKSkge1xuICAgIGNvbnN0IFtuYW1lLCB2YWx1ZV0gPSBsaW5lLnNwbGl0KC9cXHMqOlxccyovKTtcbiAgICBoZWFkZXJzW25hbWUudG9Mb3dlckNhc2UoKV0gPSB2YWx1ZTtcbiAgfVxuICByZXR1cm4gaGVhZGVycztcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0NhbnZhc1JlcXVlc3QoXG4gIHBhcmFtczogSHR0cFJlcXVlc3QsXG4gIHNpZ25lZFJlcXVlc3Q6IFNpZ25lZFJlcXVlc3RPYmplY3QsXG4gIHJlcXVlc3RCb2R5OiBzdHJpbmcsXG4pIHtcbiAgY29uc3Qgc2V0dGluZ3M6IGFueSA9IHtcbiAgICBjbGllbnQ6IHNpZ25lZFJlcXVlc3QuY2xpZW50LFxuICAgIG1ldGhvZDogcGFyYW1zLm1ldGhvZCxcbiAgICBkYXRhOiByZXF1ZXN0Qm9keSxcbiAgfTtcbiAgY29uc3QgcGFyYW1IZWFkZXJzID0gcGFyYW1zLmhlYWRlcnM7XG4gIGlmIChwYXJhbUhlYWRlcnMpIHtcbiAgICBzZXR0aW5ncy5oZWFkZXJzID0ge307XG4gICAgZm9yIChjb25zdCBuYW1lIG9mIE9iamVjdC5rZXlzKHBhcmFtSGVhZGVycykpIHtcbiAgICAgIGlmIChuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdjb250ZW50LXR5cGUnKSB7XG4gICAgICAgIHNldHRpbmdzLmNvbnRlbnRUeXBlID0gcGFyYW1IZWFkZXJzW25hbWVdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSA9IHBhcmFtSGVhZGVyc1tuYW1lXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgY29uc3QgZGF0YSA9IGF3YWl0IG5ldyBQcm9taXNlPENhbnZhc1Jlc3BvbnNlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgc2V0dGluZ3Muc3VjY2VzcyA9IHJlc29sdmU7XG4gICAgc2V0dGluZ3MuZmFpbHVyZSA9IHJlamVjdDtcbiAgICBTZmRjLmNhbnZhcy5jbGllbnQuYWpheChwYXJhbXMudXJsLCBzZXR0aW5ncyk7XG4gIH0pO1xuICBjb25zdCBoZWFkZXJzID0gcGFyc2VIZWFkZXJzKGRhdGEucmVzcG9uc2VIZWFkZXJzKTtcbiAgbGV0IHJlc3BvbnNlQm9keSA9IGRhdGEucGF5bG9hZDtcbiAgaWYgKHR5cGVvZiByZXNwb25zZUJvZHkgIT09ICdzdHJpbmcnKSB7XG4gICAgcmVzcG9uc2VCb2R5ID0gSlNPTi5zdHJpbmdpZnkocmVzcG9uc2VCb2R5KTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IGRhdGEuc3RhdHVzLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogcmVzcG9uc2VCb2R5IGFzIHN0cmluZyxcbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmVxdWVzdChzaWduZWRSZXF1ZXN0OiBTaWduZWRSZXF1ZXN0T2JqZWN0KSB7XG4gIHJldHVybiAocGFyYW1zOiBIdHRwUmVxdWVzdCkgPT4ge1xuICAgIGNvbnN0IGJ1Zjogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBzdHJlYW0gPSBuZXcgVHJhbnNmb3JtKHtcbiAgICAgIHRyYW5zZm9ybShjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7XG4gICAgICAgIGJ1Zi5wdXNoKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycgPyBjaHVuayA6IGNodW5rLnRvU3RyaW5nKCd1dGY4JykpO1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgfSxcbiAgICAgIGZsdXNoKCkge1xuICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGJvZHkgPSBidWYuam9pbignJyk7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBwcm9jZXNzQ2FudmFzUmVxdWVzdChcbiAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgIHNpZ25lZFJlcXVlc3QsXG4gICAgICAgICAgICBib2R5LFxuICAgICAgICAgICk7XG4gICAgICAgICAgc3RyZWFtLmVtaXQoJ3Jlc3BvbnNlJywgcmVzcG9uc2UpO1xuICAgICAgICAgIHN0cmVhbS5lbWl0KCdjb21wbGV0ZScsIHJlc3BvbnNlKTtcbiAgICAgICAgICBzdHJlYW0ucHVzaChyZXNwb25zZS5ib2R5KTtcbiAgICAgICAgICBzdHJlYW0ucHVzaChudWxsKTtcbiAgICAgICAgfSkoKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgaWYgKHBhcmFtcy5ib2R5KSB7XG4gICAgICBzdHJlYW0uZW5kKHBhcmFtcy5ib2R5KTtcbiAgICB9XG4gICAgcmV0dXJuIHN0cmVhbTtcbiAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQge1xuICBzdXBwb3J0ZWQ6IHR5cGVvZiBTZmRjID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgU2ZkYy5jYW52YXMgIT09ICd1bmRlZmluZWQnLFxuICBjcmVhdGVSZXF1ZXN0LFxufTtcbiJdfQ==