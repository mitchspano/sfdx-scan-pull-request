import "core-js/modules/es.array.iterator";
import "core-js/modules/es.promise";
import _Promise from "@babel/runtime-corejs3/core-js-stable/promise";
import _JSON$stringify from "@babel/runtime-corejs3/core-js-stable/json/stringify";
import os from 'os';
import fs from 'fs-extra';
import path from 'path';
import { Cli } from '../cli/cli';
import { VERSION } from '..';
import { Command } from 'commander';

function getCacheFileDir() {
  return path.join(os.tmpdir(), 'jsforce-gen-schema-cache');
}

function getCacheFilePath(orgId) {
  return path.join(getCacheFileDir(), orgId, 'describe.json');
}

async function readDescribedCache(orgId) {
  try {
    const cacheFile = getCacheFilePath(orgId);
    const data = await fs.readFile(cacheFile, 'utf8');
    return JSON.parse(data);
  } catch (e) {
    return null;
  }
}

async function loadDescribeResult(conn, orgId, cache) {
  console.info('describing global');
  const {
    sobjects: sos
  } = await conn.describeGlobal();
  const sobjects = [];

  for (const {
    name
  } of sos) {
    console.info('describing ' + name);
    const so = await conn.describe(name);
    sobjects.push(so);
  }

  if (cache) {
    const cacheFile = getCacheFilePath(orgId);
    await fs.outputFile(cacheFile, _JSON$stringify(sobjects, null, 2), 'utf8');
  }

  return sobjects;
}

function getParentReferences(sobject) {
  const parentReferences = [];

  for (const {
    type,
    nillable,
    relationshipName,
    referenceTo
  } of sobject.fields) {
    if (type === 'reference' && relationshipName && referenceTo && referenceTo.length > 0) {
      const parentSObject = referenceTo.length > 1 ? 'Name' : referenceTo[0];
      parentReferences.push({
        nillable,
        parentSObject,
        relationshipName
      });
    }
  }

  return parentReferences;
}

function getTSTypeString(type) {
  return type === 'double' || type === 'int' || type === 'currency' || type === 'percent' ? 'number' : type === 'boolean' ? 'boolean' : type === 'date' || type === 'datetime' || type === 'time' ? 'DateString' : type === 'base64' ? 'BlobString' : type === 'address' ? 'Address' : type === 'complexvalue' ? 'any' : 'string';
}

async function dumpSchema(conn, orgId, outputFile, schemaName, cache) {
  const sobjects = (cache ? await readDescribedCache(orgId) : null) || (await loadDescribeResult(conn, orgId, cache));
  await fs.ensureFile(outputFile);
  const out = fs.createWriteStream(outputFile, 'utf8');
  return new _Promise((resolve, reject) => {
    out.on('error', err => reject(err));
    out.on('finish', resolve);

    const writeLine = message => out.write(message + '\n');

    writeLine("import { Schema, SObjectDefinition, DateString, BlobString, Address } from 'jsforce';");
    writeLine('');

    for (const sobject of sobjects) {
      const {
        name,
        fields,
        childRelationships
      } = sobject;
      writeLine(`type Fields$${name} = {`);
      writeLine('  //');

      for (const {
        name,
        type,
        nillable
      } of fields) {
        const tsType = getTSTypeString(type);
        const orNull = nillable ? ' | null' : '';
        writeLine(`  ${name}: ${tsType}${orNull};`);
      }

      writeLine('};');
      writeLine('');
      writeLine(`type ParentReferences$${name} = {`);
      writeLine('  //');
      const parentReferences = getParentReferences(sobject);

      for (const {
        nillable,
        parentSObject,
        relationshipName
      } of parentReferences) {
        const orNull = nillable ? ' | null' : '';
        writeLine(`  ${relationshipName}: SObjectDefinition$${parentSObject}${orNull};`);
      }

      writeLine('};');
      writeLine('');
      writeLine(`type ChildRelationships$${name} = {`);
      writeLine('  //');

      for (const {
        field,
        childSObject,
        relationshipName
      } of childRelationships) {
        if (field && childSObject && relationshipName && !/__c$/.test(field)) {
          writeLine(`  ${relationshipName}: SObjectDefinition$${childSObject};`);
        }
      }

      writeLine('};');
      writeLine('');
      writeLine(`interface SObjectDefinition$${name} extends SObjectDefinition<'${name}'> {
    Name: '${name}';
    Fields: Fields$${name};
    ParentReferences: ParentReferences$${name};
    ChildRelationships: ChildRelationships$${name};
  }`);
      writeLine('');
    }

    writeLine('');
    writeLine(`export interface ${schemaName} extends Schema {`);
    writeLine('  SObjects: {');

    for (const {
      name
    } of sobjects) {
      writeLine(`    ${name}: SObjectDefinition$${name};`);
    }

    writeLine('  };');
    writeLine('}');
    out.end();
  });
}

/**
 *
 */
function readCommand() {
  return new Command().option('-u, --username [username]', 'Salesforce username').option('-p, --password [password]', 'Salesforce password (and security token, if available)').option('-c, --connection [connection]', 'Connection name stored in connection registry').option('-l, --loginUrl [loginUrl]', 'Salesforce login url').option('-n, --schemaName [schemaName]', 'Name of schema type', 'MySchema').requiredOption('-o, --outputFile <outputFile>', 'Generated schema file path', './schema.d.ts').option('--sandbox', 'Login to Salesforce sandbox').option('--no-cache', 'Do not generate cache file for described result in tmp directory').option('--clearCache', 'Clear all existing described cache files').version(VERSION).parse(process.argv);
}
/**
 *
 */


export default async function main() {
  const program = readCommand();
  const cli = new Cli();
  await cli.connect(program);
  const conn = cli.getCurrentConnection();

  if (!conn.userInfo) {
    console.error('Cannot connect to Salesforce');
    return;
  }

  await dumpSchema(conn, conn.userInfo.organizationId, program.outputFile, program.schemaName, program.cache);

  if (program.clearCache) {
    console.log('removing cache files');
    await fs.remove(getCacheFileDir());
  }

  console.log(`Dumped to: ${program.outputFile}`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY2hlbWEvZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbIm9zIiwiZnMiLCJwYXRoIiwiQ2xpIiwiVkVSU0lPTiIsIkNvbW1hbmQiLCJnZXRDYWNoZUZpbGVEaXIiLCJqb2luIiwidG1wZGlyIiwiZ2V0Q2FjaGVGaWxlUGF0aCIsIm9yZ0lkIiwicmVhZERlc2NyaWJlZENhY2hlIiwiY2FjaGVGaWxlIiwiZGF0YSIsInJlYWRGaWxlIiwiSlNPTiIsInBhcnNlIiwiZSIsImxvYWREZXNjcmliZVJlc3VsdCIsImNvbm4iLCJjYWNoZSIsImNvbnNvbGUiLCJpbmZvIiwic29iamVjdHMiLCJzb3MiLCJkZXNjcmliZUdsb2JhbCIsIm5hbWUiLCJzbyIsImRlc2NyaWJlIiwicHVzaCIsIm91dHB1dEZpbGUiLCJnZXRQYXJlbnRSZWZlcmVuY2VzIiwic29iamVjdCIsInBhcmVudFJlZmVyZW5jZXMiLCJ0eXBlIiwibmlsbGFibGUiLCJyZWxhdGlvbnNoaXBOYW1lIiwicmVmZXJlbmNlVG8iLCJmaWVsZHMiLCJsZW5ndGgiLCJwYXJlbnRTT2JqZWN0IiwiZ2V0VFNUeXBlU3RyaW5nIiwiZHVtcFNjaGVtYSIsInNjaGVtYU5hbWUiLCJlbnN1cmVGaWxlIiwib3V0IiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJyZXNvbHZlIiwicmVqZWN0Iiwib24iLCJlcnIiLCJ3cml0ZUxpbmUiLCJtZXNzYWdlIiwid3JpdGUiLCJjaGlsZFJlbGF0aW9uc2hpcHMiLCJ0c1R5cGUiLCJvck51bGwiLCJmaWVsZCIsImNoaWxkU09iamVjdCIsInRlc3QiLCJlbmQiLCJyZWFkQ29tbWFuZCIsIm9wdGlvbiIsInJlcXVpcmVkT3B0aW9uIiwidmVyc2lvbiIsInByb2Nlc3MiLCJhcmd2IiwibWFpbiIsInByb2dyYW0iLCJjbGkiLCJjb25uZWN0IiwiZ2V0Q3VycmVudENvbm5lY3Rpb24iLCJ1c2VySW5mbyIsImVycm9yIiwib3JnYW5pemF0aW9uSWQiLCJjbGVhckNhY2hlIiwibG9n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S0FBUixDQUFjLDhCQUFkO0FBQ0E7QUFDRDs7QUFDRCxRQUFNL0IsVUFBVSxDQUNkdkIsSUFEYyxFQUVkQSxJQUFJLENBQUNxRCxRQUFMLENBQWNFLGNBRkEsRUFHZE4sT0FBTyxDQUFDdEMsVUFITSxFQUlkc0MsT0FBTyxDQUFDekIsVUFKTSxFQUtkeUIsT0FBTyxDQUFDaEQsS0FMTSxDQUFoQjs7QUFPQSxNQUFJZ0QsT0FBTyxDQUFDTyxVQUFaLEVBQXdCO0FBQ3RCdEQsSUFBQUEsT0FBTyxDQUFDdUQsR0FBUixDQUFZLHNCQUFaO0FBQ0EsVUFBTTNFLEVBQUUsQ0FBQzRFLE1BQUgsQ0FBVXZFLGVBQWUsRUFBekIsQ0FBTjtBQUNEOztBQUNEZSxFQUFBQSxPQUFPLENBQUN1RCxHQUFSLENBQWEsY0FBYVIsT0FBTyxDQUFDdEMsVUFBVyxFQUE3QztBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IERlc2NyaWJlU09iamVjdFJlc3VsdCB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IENsaSB9IGZyb20gJy4uL2NsaS9jbGknO1xuaW1wb3J0IHsgQ29ubmVjdGlvbiwgVkVSU0lPTiB9IGZyb20gJy4uJztcbmltcG9ydCB7IENvbW1hbmQgfSBmcm9tICdjb21tYW5kZXInO1xuXG50eXBlIFVud3JhcFByb21pc2U8VD4gPSBUIGV4dGVuZHMgUHJvbWlzZTxpbmZlciBVPiA/IFUgOiBuZXZlcjtcblxuZnVuY3Rpb24gZ2V0Q2FjaGVGaWxlRGlyKCkge1xuICByZXR1cm4gcGF0aC5qb2luKG9zLnRtcGRpcigpLCAnanNmb3JjZS1nZW4tc2NoZW1hLWNhY2hlJyk7XG59XG5cbmZ1bmN0aW9uIGdldENhY2hlRmlsZVBhdGgob3JnSWQ6IHN0cmluZykge1xuICByZXR1cm4gcGF0aC5qb2luKGdldENhY2hlRmlsZURpcigpLCBvcmdJZCwgJ2Rlc2NyaWJlLmpzb24nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVhZERlc2NyaWJlZENhY2hlKFxuICBvcmdJZDogc3RyaW5nLFxuKTogUHJvbWlzZTxVbndyYXBQcm9taXNlPFJldHVyblR5cGU8dHlwZW9mIGxvYWREZXNjcmliZVJlc3VsdD4+IHwgbnVsbD4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNhY2hlRmlsZSA9IGdldENhY2hlRmlsZVBhdGgob3JnSWQpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZShjYWNoZUZpbGUsICd1dGY4Jyk7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBsb2FkRGVzY3JpYmVSZXN1bHQoXG4gIGNvbm46IENvbm5lY3Rpb24sXG4gIG9yZ0lkOiBzdHJpbmcsXG4gIGNhY2hlPzogYm9vbGVhbixcbikge1xuICBjb25zb2xlLmluZm8oJ2Rlc2NyaWJpbmcgZ2xvYmFsJyk7XG4gIGNvbnN0IHsgc29iamVjdHM6IHNvcyB9ID0gYXdhaXQgY29ubi5kZXNjcmliZUdsb2JhbCgpO1xuICBjb25zdCBzb2JqZWN0cyA9IFtdO1xuICBmb3IgKGNvbnN0IHsgbmFtZSB9IG9mIHNvcykge1xuICAgIGNvbnNvbGUuaW5mbygnZGVzY3JpYmluZyAnICsgbmFtZSk7XG4gICAgY29uc3Qgc28gPSBhd2FpdCBjb25uLmRlc2NyaWJlKG5hbWUpO1xuICAgIHNvYmplY3RzLnB1c2goc28pO1xuICB9XG4gIGlmIChjYWNoZSkge1xuICAgIGNvbnN0IGNhY2hlRmlsZSA9IGdldENhY2hlRmlsZVBhdGgob3JnSWQpO1xuICAgIGF3YWl0IGZzLm91dHB1dEZpbGUoY2FjaGVGaWxlLCBKU09OLnN0cmluZ2lmeShzb2JqZWN0cywgbnVsbCwgMiksICd1dGY4Jyk7XG4gIH1cbiAgcmV0dXJuIHNvYmplY3RzO1xufVxuXG5mdW5jdGlvbiBnZXRQYXJlbnRSZWZlcmVuY2VzKHNvYmplY3Q6IERlc2NyaWJlU09iamVjdFJlc3VsdCkge1xuICBjb25zdCBwYXJlbnRSZWZlcmVuY2VzID0gW107XG4gIGZvciAoY29uc3Qge1xuICAgIHR5cGUsXG4gICAgbmlsbGFibGUsXG4gICAgcmVsYXRpb25zaGlwTmFtZSxcbiAgICByZWZlcmVuY2VUbyxcbiAgfSBvZiBzb2JqZWN0LmZpZWxkcykge1xuICAgIGlmIChcbiAgICAgIHR5cGUgPT09ICdyZWZlcmVuY2UnICYmXG4gICAgICByZWxhdGlvbnNoaXBOYW1lICYmXG4gICAgICByZWZlcmVuY2VUbyAmJlxuICAgICAgcmVmZXJlbmNlVG8ubGVuZ3RoID4gMFxuICAgICkge1xuICAgICAgY29uc3QgcGFyZW50U09iamVjdCA9IHJlZmVyZW5jZVRvLmxlbmd0aCA+IDEgPyAnTmFtZScgOiByZWZlcmVuY2VUb1swXTtcbiAgICAgIHBhcmVudFJlZmVyZW5jZXMucHVzaCh7IG5pbGxhYmxlLCBwYXJlbnRTT2JqZWN0LCByZWxhdGlvbnNoaXBOYW1lIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcGFyZW50UmVmZXJlbmNlcztcbn1cblxuZnVuY3Rpb24gZ2V0VFNUeXBlU3RyaW5nKHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiB0eXBlID09PSAnZG91YmxlJyB8fFxuICAgIHR5cGUgPT09ICdpbnQnIHx8XG4gICAgdHlwZSA9PT0gJ2N1cnJlbmN5JyB8fFxuICAgIHR5cGUgPT09ICdwZXJjZW50J1xuICAgID8gJ251bWJlcidcbiAgICA6IHR5cGUgPT09ICdib29sZWFuJ1xuICAgID8gJ2Jvb2xlYW4nXG4gICAgOiB0eXBlID09PSAnZGF0ZScgfHwgdHlwZSA9PT0gJ2RhdGV0aW1lJyB8fCB0eXBlID09PSAndGltZSdcbiAgICA/ICdEYXRlU3RyaW5nJ1xuICAgIDogdHlwZSA9PT0gJ2Jhc2U2NCdcbiAgICA/ICdCbG9iU3RyaW5nJ1xuICAgIDogdHlwZSA9PT0gJ2FkZHJlc3MnXG4gICAgPyAnQWRkcmVzcydcbiAgICA6IHR5cGUgPT09ICdjb21wbGV4dmFsdWUnXG4gICAgPyAnYW55J1xuICAgIDogJ3N0cmluZyc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGR1bXBTY2hlbWEoXG4gIGNvbm46IENvbm5lY3Rpb24sXG4gIG9yZ0lkOiBzdHJpbmcsXG4gIG91dHB1dEZpbGU6IHN0cmluZyxcbiAgc2NoZW1hTmFtZTogc3RyaW5nLFxuICBjYWNoZT86IGJvb2xlYW4sXG4pIHtcbiAgY29uc3Qgc29iamVjdHMgPVxuICAgIChjYWNoZSA/IGF3YWl0IHJlYWREZXNjcmliZWRDYWNoZShvcmdJZCkgOiBudWxsKSB8fFxuICAgIChhd2FpdCBsb2FkRGVzY3JpYmVSZXN1bHQoY29ubiwgb3JnSWQsIGNhY2hlKSk7XG4gIGF3YWl0IGZzLmVuc3VyZUZpbGUob3V0cHV0RmlsZSk7XG4gIGNvbnN0IG91dCA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKG91dHB1dEZpbGUsICd1dGY4Jyk7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgb3V0Lm9uKCdlcnJvcicsIChlcnIpID0+IHJlamVjdChlcnIpKTtcbiAgICBvdXQub24oJ2ZpbmlzaCcsIHJlc29sdmUpO1xuICAgIGNvbnN0IHdyaXRlTGluZSA9IChtZXNzYWdlOiBzdHJpbmcpID0+IG91dC53cml0ZShtZXNzYWdlICsgJ1xcbicpO1xuICAgIHdyaXRlTGluZShcbiAgICAgIFwiaW1wb3J0IHsgU2NoZW1hLCBTT2JqZWN0RGVmaW5pdGlvbiwgRGF0ZVN0cmluZywgQmxvYlN0cmluZywgQWRkcmVzcyB9IGZyb20gJ2pzZm9yY2UnO1wiLFxuICAgICk7XG4gICAgd3JpdGVMaW5lKCcnKTtcbiAgICBmb3IgKGNvbnN0IHNvYmplY3Qgb2Ygc29iamVjdHMpIHtcbiAgICAgIGNvbnN0IHsgbmFtZSwgZmllbGRzLCBjaGlsZFJlbGF0aW9uc2hpcHMgfSA9IHNvYmplY3Q7XG4gICAgICB3cml0ZUxpbmUoYHR5cGUgRmllbGRzJCR7bmFtZX0gPSB7YCk7XG4gICAgICB3cml0ZUxpbmUoJyAgLy8nKTtcbiAgICAgIGZvciAoY29uc3QgeyBuYW1lLCB0eXBlLCBuaWxsYWJsZSB9IG9mIGZpZWxkcykge1xuICAgICAgICBjb25zdCB0c1R5cGUgPSBnZXRUU1R5cGVTdHJpbmcodHlwZSk7XG4gICAgICAgIGNvbnN0IG9yTnVsbCA9IG5pbGxhYmxlID8gJyB8IG51bGwnIDogJyc7XG4gICAgICAgIHdyaXRlTGluZShgICAke25hbWV9OiAke3RzVHlwZX0ke29yTnVsbH07YCk7XG4gICAgICB9XG4gICAgICB3cml0ZUxpbmUoJ307Jyk7XG4gICAgICB3cml0ZUxpbmUoJycpO1xuICAgICAgd3JpdGVMaW5lKGB0eXBlIFBhcmVudFJlZmVyZW5jZXMkJHtuYW1lfSA9IHtgKTtcbiAgICAgIHdyaXRlTGluZSgnICAvLycpO1xuICAgICAgY29uc3QgcGFyZW50UmVmZXJlbmNlcyA9IGdldFBhcmVudFJlZmVyZW5jZXMoc29iamVjdCk7XG4gICAgICBmb3IgKGNvbnN0IHtcbiAgICAgICAgbmlsbGFibGUsXG4gICAgICAgIHBhcmVudFNPYmplY3QsXG4gICAgICAgIHJlbGF0aW9uc2hpcE5hbWUsXG4gICAgICB9IG9mIHBhcmVudFJlZmVyZW5jZXMpIHtcbiAgICAgICAgY29uc3Qgb3JOdWxsID0gbmlsbGFibGUgPyAnIHwgbnVsbCcgOiAnJztcbiAgICAgICAgd3JpdGVMaW5lKFxuICAgICAgICAgIGAgICR7cmVsYXRpb25zaGlwTmFtZX06IFNPYmplY3REZWZpbml0aW9uJCR7cGFyZW50U09iamVjdH0ke29yTnVsbH07YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHdyaXRlTGluZSgnfTsnKTtcbiAgICAgIHdyaXRlTGluZSgnJyk7XG4gICAgICB3cml0ZUxpbmUoYHR5cGUgQ2hpbGRSZWxhdGlvbnNoaXBzJCR7bmFtZX0gPSB7YCk7XG4gICAgICB3cml0ZUxpbmUoJyAgLy8nKTtcbiAgICAgIGZvciAoY29uc3Qge1xuICAgICAgICBmaWVsZCxcbiAgICAgICAgY2hpbGRTT2JqZWN0LFxuICAgICAgICByZWxhdGlvbnNoaXBOYW1lLFxuICAgICAgfSBvZiBjaGlsZFJlbGF0aW9uc2hpcHMpIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGNoaWxkU09iamVjdCAmJiByZWxhdGlvbnNoaXBOYW1lICYmICEvX19jJC8udGVzdChmaWVsZCkpIHtcbiAgICAgICAgICB3cml0ZUxpbmUoXG4gICAgICAgICAgICBgICAke3JlbGF0aW9uc2hpcE5hbWV9OiBTT2JqZWN0RGVmaW5pdGlvbiQke2NoaWxkU09iamVjdH07YCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB3cml0ZUxpbmUoJ307Jyk7XG4gICAgICB3cml0ZUxpbmUoJycpO1xuICAgICAgd3JpdGVMaW5lKFxuICAgICAgICBgaW50ZXJmYWNlIFNPYmplY3REZWZpbml0aW9uJCR7bmFtZX0gZXh0ZW5kcyBTT2JqZWN0RGVmaW5pdGlvbjwnJHtuYW1lfSc+IHtcbiAgICBOYW1lOiAnJHtuYW1lfSc7XG4gICAgRmllbGRzOiBGaWVsZHMkJHtuYW1lfTtcbiAgICBQYXJlbnRSZWZlcmVuY2VzOiBQYXJlbnRSZWZlcmVuY2VzJCR7bmFtZX07XG4gICAgQ2hpbGRSZWxhdGlvbnNoaXBzOiBDaGlsZFJlbGF0aW9uc2hpcHMkJHtuYW1lfTtcbiAgfWAsXG4gICAgICApO1xuICAgICAgd3JpdGVMaW5lKCcnKTtcbiAgICB9XG4gICAgd3JpdGVMaW5lKCcnKTtcbiAgICB3cml0ZUxpbmUoYGV4cG9ydCBpbnRlcmZhY2UgJHtzY2hlbWFOYW1lfSBleHRlbmRzIFNjaGVtYSB7YCk7XG4gICAgd3JpdGVMaW5lKCcgIFNPYmplY3RzOiB7Jyk7XG4gICAgZm9yIChjb25zdCB7IG5hbWUgfSBvZiBzb2JqZWN0cykge1xuICAgICAgd3JpdGVMaW5lKGAgICAgJHtuYW1lfTogU09iamVjdERlZmluaXRpb24kJHtuYW1lfTtgKTtcbiAgICB9XG4gICAgd3JpdGVMaW5lKCcgIH07Jyk7XG4gICAgd3JpdGVMaW5lKCd9Jyk7XG4gICAgb3V0LmVuZCgpO1xuICB9KTtcbn1cblxuaW50ZXJmYWNlIEdlbmVyYXRvckNvbW1hbmQgZXh0ZW5kcyBDb21tYW5kIHtcbiAgY29ubmVjdGlvbj86IHN0cmluZztcbiAgdXNlcm5hbWU/OiBzdHJpbmc7XG4gIHBhc3N3b3JkPzogc3RyaW5nO1xuICBsb2dpblVybD86IHN0cmluZztcbiAgc2FuZGJveD86IGJvb2xlYW47XG4gIG91dHB1dEZpbGU6IHN0cmluZztcbiAgY2FjaGU/OiBib29sZWFuO1xuICBjbGVhckNhY2hlPzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKlxuICovXG5mdW5jdGlvbiByZWFkQ29tbWFuZCgpOiBHZW5lcmF0b3JDb21tYW5kIHtcbiAgcmV0dXJuIG5ldyBDb21tYW5kKClcbiAgICAub3B0aW9uKCctdSwgLS11c2VybmFtZSBbdXNlcm5hbWVdJywgJ1NhbGVzZm9yY2UgdXNlcm5hbWUnKVxuICAgIC5vcHRpb24oXG4gICAgICAnLXAsIC0tcGFzc3dvcmQgW3Bhc3N3b3JkXScsXG4gICAgICAnU2FsZXNmb3JjZSBwYXNzd29yZCAoYW5kIHNlY3VyaXR5IHRva2VuLCBpZiBhdmFpbGFibGUpJyxcbiAgICApXG4gICAgLm9wdGlvbihcbiAgICAgICctYywgLS1jb25uZWN0aW9uIFtjb25uZWN0aW9uXScsXG4gICAgICAnQ29ubmVjdGlvbiBuYW1lIHN0b3JlZCBpbiBjb25uZWN0aW9uIHJlZ2lzdHJ5JyxcbiAgICApXG4gICAgLm9wdGlvbignLWwsIC0tbG9naW5VcmwgW2xvZ2luVXJsXScsICdTYWxlc2ZvcmNlIGxvZ2luIHVybCcpXG4gICAgLm9wdGlvbignLW4sIC0tc2NoZW1hTmFtZSBbc2NoZW1hTmFtZV0nLCAnTmFtZSBvZiBzY2hlbWEgdHlwZScsICdNeVNjaGVtYScpXG4gICAgLnJlcXVpcmVkT3B0aW9uKFxuICAgICAgJy1vLCAtLW91dHB1dEZpbGUgPG91dHB1dEZpbGU+JyxcbiAgICAgICdHZW5lcmF0ZWQgc2NoZW1hIGZpbGUgcGF0aCcsXG4gICAgICAnLi9zY2hlbWEuZC50cycsXG4gICAgKVxuICAgIC5vcHRpb24oJy0tc2FuZGJveCcsICdMb2dpbiB0byBTYWxlc2ZvcmNlIHNhbmRib3gnKVxuICAgIC5vcHRpb24oXG4gICAgICAnLS1uby1jYWNoZScsXG4gICAgICAnRG8gbm90IGdlbmVyYXRlIGNhY2hlIGZpbGUgZm9yIGRlc2NyaWJlZCByZXN1bHQgaW4gdG1wIGRpcmVjdG9yeScsXG4gICAgKVxuICAgIC5vcHRpb24oJy0tY2xlYXJDYWNoZScsICdDbGVhciBhbGwgZXhpc3RpbmcgZGVzY3JpYmVkIGNhY2hlIGZpbGVzJylcbiAgICAudmVyc2lvbihWRVJTSU9OKVxuICAgIC5wYXJzZShwcm9jZXNzLmFyZ3YpIGFzIEdlbmVyYXRvckNvbW1hbmQ7XG59XG5cbi8qKlxuICpcbiAqL1xuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcbiAgY29uc3QgcHJvZ3JhbSA9IHJlYWRDb21tYW5kKCk7XG4gIGNvbnN0IGNsaSA9IG5ldyBDbGkoKTtcbiAgYXdhaXQgY2xpLmNvbm5lY3QocHJvZ3JhbSk7XG4gIGNvbnN0IGNvbm4gPSBjbGkuZ2V0Q3VycmVudENvbm5lY3Rpb24oKTtcbiAgaWYgKCFjb25uLnVzZXJJbmZvKSB7XG4gICAgY29uc29sZS5lcnJvcignQ2Fubm90IGNvbm5lY3QgdG8gU2FsZXNmb3JjZScpO1xuICAgIHJldHVybjtcbiAgfVxuICBhd2FpdCBkdW1wU2NoZW1hKFxuICAgIGNvbm4sXG4gICAgY29ubi51c2VySW5mby5vcmdhbml6YXRpb25JZCxcbiAgICBwcm9ncmFtLm91dHB1dEZpbGUsXG4gICAgcHJvZ3JhbS5zY2hlbWFOYW1lLFxuICAgIHByb2dyYW0uY2FjaGUsXG4gICk7XG4gIGlmIChwcm9ncmFtLmNsZWFyQ2FjaGUpIHtcbiAgICBjb25zb2xlLmxvZygncmVtb3ZpbmcgY2FjaGUgZmlsZXMnKTtcbiAgICBhd2FpdCBmcy5yZW1vdmUoZ2V0Q2FjaGVGaWxlRGlyKCkpO1xuICB9XG4gIGNvbnNvbGUubG9nKGBEdW1wZWQgdG86ICR7cHJvZ3JhbS5vdXRwdXRGaWxlfWApO1xufVxuIl19