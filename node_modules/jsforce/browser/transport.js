import _Object$defineProperty from "@babel/runtime-corejs3/core-js-stable/object/define-property";
import _Object$defineProperties from "@babel/runtime-corejs3/core-js-stable/object/define-properties";
import _Object$getOwnPropertyDescriptors from "@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors";
import _forEachInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/for-each";
import _Object$getOwnPropertyDescriptor from "@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor";
import _filterInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/filter";
import _Object$getOwnPropertySymbols from "@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols";
import _Reflect$construct from "@babel/runtime-corejs3/core-js-stable/reflect/construct";
import "core-js/modules/es.regexp.exec";
import _indexOfInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/index-of";
import _objectWithoutProperties from "@babel/runtime-corejs3/helpers/objectWithoutProperties";
import _get from "@babel/runtime-corejs3/helpers/get";
import _Date$now from "@babel/runtime-corejs3/core-js-stable/date/now";
import _concatInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/concat";
import _Object$keys2 from "@babel/runtime-corejs3/core-js-stable/object/keys";
import _assertThisInitialized from "@babel/runtime-corejs3/helpers/assertThisInitialized";
import _inherits from "@babel/runtime-corejs3/helpers/inherits";
import _possibleConstructorReturn from "@babel/runtime-corejs3/helpers/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime-corejs3/helpers/getPrototypeOf";
import _defineProperty from "@babel/runtime-corejs3/helpers/defineProperty";
import _Promise from "@babel/runtime-corejs3/core-js-stable/promise";
import _classCallCheck from "@babel/runtime-corejs3/helpers/classCallCheck";
import _createClass from "@babel/runtime-corejs3/helpers/createClass";
import _parseInt from "@babel/runtime-corejs3/core-js-stable/parse-int";

var _ref, _process$env$HTTPS_PR;

function ownKeys(object, enumerableOnly) { var keys = _Object$keys2(object); if (_Object$getOwnPropertySymbols) { var symbols = _Object$getOwnPropertySymbols(object); if (enumerableOnly) symbols = _filterInstanceProperty(symbols).call(symbols, function (sym) { return _Object$getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { var _context3; _forEachInstanceProperty(_context3 = ownKeys(Object(source), true)).call(_context3, function (key) { _defineProperty(target, key, source[key]); }); } else if (_Object$getOwnPropertyDescriptors) { _Object$defineProperties(target, _Object$getOwnPropertyDescriptors(source)); } else { var _context4; _forEachInstanceProperty(_context4 = ownKeys(Object(source))).call(_context4, function (key) { _Object$defineProperty(target, key, _Object$getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = _Reflect$construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !_Reflect$construct) return false; if (_Reflect$construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(_Reflect$construct(Date, [], function () {})); return true; } catch (e) { return false; } }

/**
 *
 */
import request, { setDefaults } from './request';
import { StreamPromise } from './util/promise';
import jsonp from './browser/jsonp';
import canvas from './browser/canvas';
/**
 * Normarize Salesforce API host name
 * @private
 */

function normalizeApiHost(apiHost) {
  var m = /(\w+)\.(visual\.force|salesforce)\.com$/.exec(apiHost);

  if (m) {
    return "".concat(m[1], ".salesforce.com");
  }

  return apiHost;
}

setDefaults({
  httpProxy: (_ref = (_process$env$HTTPS_PR = process.env.HTTPS_PROXY) !== null && _process$env$HTTPS_PR !== void 0 ? _process$env$HTTPS_PR : process.env.HTTP_PROXY) !== null && _ref !== void 0 ? _ref : undefined,
  timeout: process.env.HTTP_TIMEOUT ? _parseInt(process.env.HTTP_TIMEOUT, 10) : undefined
});
var baseUrl = typeof window !== 'undefined' && window.location && window.location.host ? "https://".concat(normalizeApiHost(window.location.host)) : process.env.LOCATION_BASE_URL || '';
/**
 * Class for HTTP request transport
 *
 * @class
 * @protected
 */

export var Transport = /*#__PURE__*/function () {
  function Transport() {
    _classCallCheck(this, Transport);
  }

  _createClass(Transport, [{
    key: "httpRequest",

    /**
     */
    value: function httpRequest(req) {
      var _this = this;

      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
      return StreamPromise.create(function () {
        var createStream = _this.getRequestStreamCreator();

        var stream = createStream(req, options);
        var promise = new _Promise(function (resolve, reject) {
          stream.on('complete', function (res) {
            return resolve(res);
          }).on('error', reject);
        });
        return {
          stream: stream,
          promise: promise
        };
      });
    }
    /**
     * @protected
     */

  }, {
    key: "getRequestStreamCreator",
    value: function getRequestStreamCreator() {
      return request;
    }
  }]);

  return Transport;
}();
/**
 * Class for JSONP request transport
 */

export var JsonpTransport = /*#__PURE__*/function (_Transport) {
  _inherits(JsonpTransport, _Transport);

  var _super = _createSuper(JsonpTransport);

  function JsonpTransport(jsonpParam) {
    var _this2;

    _classCallCheck(this, JsonpTransport);

    _this2 = _super.call(this);

    _defineProperty(_assertThisInitialized(_this2), "_jsonpParam", void 0);

    _this2._jsonpParam = jsonpParam;
    return _this2;
  }

  _createClass(JsonpTransport, [{
    key: "getRequestStreamCreator",
    value: function getRequestStreamCreator() {
      var jsonpRequest = jsonp.createRequest(this._jsonpParam);
      return function (params) {
        return jsonpRequest(params);
      };
    }
  }]);

  return JsonpTransport;
}(Transport);
/**
 * Class for Sfdc Canvas request transport
 */

_defineProperty(JsonpTransport, "supprted", jsonp.supported);

export var CanvasTransport = /*#__PURE__*/function (_Transport2) {
  _inherits(CanvasTransport, _Transport2);

  var _super2 = _createSuper(CanvasTransport);

  function CanvasTransport(signedRequest) {
    var _this3;

    _classCallCheck(this, CanvasTransport);

    _this3 = _super2.call(this);

    _defineProperty(_assertThisInitialized(_this3), "_signedRequest", void 0);

    _this3._signedRequest = signedRequest;
    return _this3;
  }

  _createClass(CanvasTransport, [{
    key: "getRequestStreamCreator",
    value: function getRequestStreamCreator() {
      var canvasRequest = canvas.createRequest(this._signedRequest);
      return function (params) {
        return canvasRequest(params);
      };
    }
  }]);

  return CanvasTransport;
}(Transport);
/* @private */

_defineProperty(CanvasTransport, "supported", canvas.supported);

function createXdProxyRequest(req, proxyUrl) {
  var _context, _context2;

  var headers = {
    'salesforceproxy-endpoint': req.url
  };

  if (req.headers) {
    for (var _i = 0, _Object$keys = _Object$keys2(req.headers); _i < _Object$keys.length; _i++) {
      var _name = _Object$keys[_i];
      headers[_name] = req.headers[_name];
    }
  }

  var nocache = _concatInstanceProperty(_context = "".concat(_Date$now(), ".")).call(_context, String(Math.random()).substring(2));

  return _objectSpread({
    method: req.method,
    url: _concatInstanceProperty(_context2 = "".concat(proxyUrl, "?")).call(_context2, nocache),
    headers: headers
  }, req.body != null ? {
    body: req.body
  } : {});
}
/**
 * Class for HTTP request transport using cross-domain AJAX proxy service
 */


export var XdProxyTransport = /*#__PURE__*/function (_Transport3) {
  _inherits(XdProxyTransport, _Transport3);

  var _super3 = _createSuper(XdProxyTransport);

  function XdProxyTransport(xdProxyUrl) {
    var _this4;

    _classCallCheck(this, XdProxyTransport);

    _this4 = _super3.call(this);

    _defineProperty(_assertThisInitialized(_this4), "_xdProxyUrl", void 0);

    _this4._xdProxyUrl = xdProxyUrl;
    return _this4;
  }
  /**
   * Make HTTP request via AJAX proxy
   */


  _createClass(XdProxyTransport, [{
    key: "httpRequest",
    value: function httpRequest(req) {
      var _options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var xdProxyUrl = this._xdProxyUrl;

      var url = req.url,
          body = req.body,
          rreq = _objectWithoutProperties(req, ["url", "body"]);

      var canonicalUrl = _indexOfInstanceProperty(url).call(url, '/') === 0 ? baseUrl + url : url;
      var xdProxyReq = createXdProxyRequest(_objectSpread(_objectSpread({}, rreq), {}, {
        url: canonicalUrl,
        body: body
      }), xdProxyUrl);
      return _get(_getPrototypeOf(XdProxyTransport.prototype), "httpRequest", this).call(this, xdProxyReq, {
        followRedirect: function followRedirect(redirectUrl) {
          return createXdProxyRequest(_objectSpread(_objectSpread({}, rreq), {}, {
            method: 'GET',
            url: redirectUrl
          }), xdProxyUrl);
        }
      });
    }
  }]);

  return XdProxyTransport;
}(Transport);
/**
 * Class for HTTP request transport using a proxy server
 */

export var HttpProxyTransport = /*#__PURE__*/function (_Transport4) {
  _inherits(HttpProxyTransport, _Transport4);

  var _super4 = _createSuper(HttpProxyTransport);

  function HttpProxyTransport(httpProxy) {
    var _this5;

    _classCallCheck(this, HttpProxyTransport);

    _this5 = _super4.call(this);

    _defineProperty(_assertThisInitialized(_this5), "_httpProxy", void 0);

    _this5._httpProxy = httpProxy;
    return _this5;
  }
  /**
   * Make HTTP request via proxy server
   */


  _createClass(HttpProxyTransport, [{
    key: "httpRequest",
    value: function httpRequest(req) {
      var options_ = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var options = _objectSpread(_objectSpread({}, options_), {}, {
        httpProxy: this._httpProxy
      });

      return _get(_getPrototypeOf(HttpProxyTransport.prototype), "httpRequest", this).call(this, req, options);
    }
  }]);

  return HttpProxyTransport;
}(Transport);
export default Transport;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmFuc3BvcnQudHMiXSwibmFtZXMiOlsicmVxdWVzdCIsInNldERlZmF1bHRzIiwiU3RyZWFtUHJvbWlzZSIsImpzb25wIiwiY2FudmFzIiwibm9ybWFsaXplQXBpSG9zdCIsImFwaUhvc3QiLCJtIiwiZXhlYyIsImh0dHBQcm94eSIsInByb2Nlc3MiLCJlbnYiLCJIVFRQU19QUk9YWSIsIkhUVFBfUFJPWFkiLCJ1bmRlZmluZWQiLCJ0aW1lb3V0IiwiSFRUUF9USU1FT1VUIiwiYmFzZVVybCIsIndpbmRvdyIsImxvY2F0aW9uIiwiaG9zdCIsIkxPQ0FUSU9OX0JBU0VfVVJMIiwiVHJhbnNwb3J0IiwicmVxIiwib3B0aW9ucyIsImNyZWF0ZSIsImNyZWF0ZVN0cmVhbSIsImdldFJlcXVlc3RTdHJlYW1DcmVhdG9yIiwic3RyZWFtIiwicHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJvbiIsInJlcyIsIkpzb25wVHJhbnNwb3J0IiwianNvbnBQYXJhbSIsIl9qc29ucFBhcmFtIiwianNvbnBSZXF1ZXN0IiwiY3JlYXRlUmVxdWVzdCIsInBhcmFtcyIsInN1cHBvcnRlZCIsIkNhbnZhc1RyYW5zcG9ydCIsInNpZ25lZFJlcXVlc3QiLCJfc2lnbmVkUmVxdWVzdCIsImNhbnZhc1JlcXVlc3QiLCJjcmVhdGVYZFByb3h5UmVxdWVzdCIsInByb3h5VXJsIiwiaGVhZGVycyIsInVybCIsIm5hbWUiLCJub2NhY2hlIiwiU3RyaW5nIiwiTWF0aCIsInJhbmRvbSIsInN1YnN0cmluZyIsIm1ldGhvZCIsImJvZHkiLCJYZFByb3h5VHJhbnNwb3J0IiwieGRQcm94eVVybCIsIl94ZFByb3h5VXJsIiwiX29wdGlvbnMiLCJycmVxIiwiY2Fub25pY2FsVXJsIiwieGRQcm94eVJlcSIsImZvbGxvd1JlZGlyZWN0IiwicmVkaXJlY3RVcmwiLCJIdHRwUHJveHlUcmFuc3BvcnQiLCJfaHR0cFByb3h5Iiwib3B0aW9uc18iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7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RWlCO0FBRGIsY0FFbEJQLFVBRmtCLENBRE47QUFBQTtBQURtQixPQUFyQztBQU9EO0FBMUJIOztBQUFBO0FBQUEsRUFBc0NwQyxTQUF0QztBQTZCQTtBQUNBO0FBQ0E7O0FBQ0EsV0FBYTRDLGtCQUFiO0FBQUE7O0FBQUE7O0FBR0UsOEJBQVl6RCxTQUFaLEVBQStCO0FBQUE7O0FBQUE7O0FBQzdCOztBQUQ2Qjs7QUFFN0IsV0FBSzBELFVBQUwsR0FBa0IxRCxTQUFsQjtBQUY2QjtBQUc5QjtBQUVEO0FBQ0Y7QUFDQTs7O0FBVkE7QUFBQTtBQUFBLGdDQVdjYyxHQVhkLEVBV21FO0FBQUEsVUFBbkM2QyxRQUFtQyx1RUFBSixFQUFJOztBQUMvRCxVQUFNNUMsT0FBTyxtQ0FBUTRDLFFBQVI7QUFBa0IzRCxRQUFBQSxTQUFTLEVBQUUsS0FBSzBEO0FBQWxDLFFBQWI7O0FBQ0EsaUdBQXlCNUMsR0FBekIsRUFBOEJDLE9BQTlCO0FBQ0Q7QUFkSDs7QUFBQTtBQUFBLEVBQXdDRixTQUF4QztBQWlCQSxlQUFlQSxTQUFmIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICovXG5pbXBvcnQgeyBEdXBsZXggfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHJlcXVlc3QsIHsgc2V0RGVmYXVsdHMgfSBmcm9tICcuL3JlcXVlc3QnO1xuaW1wb3J0IHsgSHR0cFJlcXVlc3QsIEh0dHBSZXF1ZXN0T3B0aW9ucywgSHR0cFJlc3BvbnNlIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBTdHJlYW1Qcm9taXNlIH0gZnJvbSAnLi91dGlsL3Byb21pc2UnO1xuaW1wb3J0IGpzb25wIGZyb20gJy4vYnJvd3Nlci9qc29ucCc7XG5pbXBvcnQgY2FudmFzIGZyb20gJy4vYnJvd3Nlci9jYW52YXMnO1xuXG4vKipcbiAqIE5vcm1hcml6ZSBTYWxlc2ZvcmNlIEFQSSBob3N0IG5hbWVcbiAqIEBwcml2YXRlXG4gKi9cbmZ1bmN0aW9uIG5vcm1hbGl6ZUFwaUhvc3QoYXBpSG9zdDogc3RyaW5nKSB7XG4gIGNvbnN0IG0gPSAvKFxcdyspXFwuKHZpc3VhbFxcLmZvcmNlfHNhbGVzZm9yY2UpXFwuY29tJC8uZXhlYyhhcGlIb3N0KTtcbiAgaWYgKG0pIHtcbiAgICByZXR1cm4gYCR7bVsxXX0uc2FsZXNmb3JjZS5jb21gO1xuICB9XG4gIHJldHVybiBhcGlIb3N0O1xufVxuXG5zZXREZWZhdWx0cyh7XG4gIGh0dHBQcm94eTogcHJvY2Vzcy5lbnYuSFRUUFNfUFJPWFkgPz8gcHJvY2Vzcy5lbnYuSFRUUF9QUk9YWSA/PyB1bmRlZmluZWQsXG4gIHRpbWVvdXQ6IHByb2Nlc3MuZW52LkhUVFBfVElNRU9VVFxuICAgID8gcGFyc2VJbnQocHJvY2Vzcy5lbnYuSFRUUF9USU1FT1VULCAxMClcbiAgICA6IHVuZGVmaW5lZCxcbn0pO1xuXG5jb25zdCBiYXNlVXJsID1cbiAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5ob3N0XG4gICAgPyBgaHR0cHM6Ly8ke25vcm1hbGl6ZUFwaUhvc3Qod2luZG93LmxvY2F0aW9uLmhvc3QpfWBcbiAgICA6IHByb2Nlc3MuZW52LkxPQ0FUSU9OX0JBU0VfVVJMIHx8ICcnO1xuXG4vKipcbiAqIENsYXNzIGZvciBIVFRQIHJlcXVlc3QgdHJhbnNwb3J0XG4gKlxuICogQGNsYXNzXG4gKiBAcHJvdGVjdGVkXG4gKi9cbmV4cG9ydCBjbGFzcyBUcmFuc3BvcnQge1xuICAvKipcbiAgICovXG4gIGh0dHBSZXF1ZXN0KFxuICAgIHJlcTogSHR0cFJlcXVlc3QsXG4gICAgb3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zID0ge30sXG4gICk6IFN0cmVhbVByb21pc2U8SHR0cFJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIFN0cmVhbVByb21pc2UuY3JlYXRlKCgpID0+IHtcbiAgICAgIGNvbnN0IGNyZWF0ZVN0cmVhbSA9IHRoaXMuZ2V0UmVxdWVzdFN0cmVhbUNyZWF0b3IoKTtcbiAgICAgIGNvbnN0IHN0cmVhbSA9IGNyZWF0ZVN0cmVhbShyZXEsIG9wdGlvbnMpO1xuICAgICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlPEh0dHBSZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBzdHJlYW1cbiAgICAgICAgICAub24oJ2NvbXBsZXRlJywgKHJlczogSHR0cFJlc3BvbnNlKSA9PiByZXNvbHZlKHJlcykpXG4gICAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7IHN0cmVhbSwgcHJvbWlzZSB9O1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcm90ZWN0ZWRcbiAgICovXG4gIGdldFJlcXVlc3RTdHJlYW1DcmVhdG9yKCk6IChcbiAgICByZXE6IEh0dHBSZXF1ZXN0LFxuICAgIG9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucyxcbiAgKSA9PiBEdXBsZXgge1xuICAgIHJldHVybiByZXF1ZXN0O1xuICB9XG59XG5cbi8qKlxuICogQ2xhc3MgZm9yIEpTT05QIHJlcXVlc3QgdHJhbnNwb3J0XG4gKi9cbmV4cG9ydCBjbGFzcyBKc29ucFRyYW5zcG9ydCBleHRlbmRzIFRyYW5zcG9ydCB7XG4gIHN0YXRpYyBzdXBwcnRlZDogYm9vbGVhbiA9IGpzb25wLnN1cHBvcnRlZDtcbiAgX2pzb25wUGFyYW06IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihqc29ucFBhcmFtOiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2pzb25wUGFyYW0gPSBqc29ucFBhcmFtO1xuICB9XG5cbiAgZ2V0UmVxdWVzdFN0cmVhbUNyZWF0b3IoKTogKFxuICAgIHJlcTogSHR0cFJlcXVlc3QsXG4gICAgb3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zLFxuICApID0+IER1cGxleCB7XG4gICAgY29uc3QganNvbnBSZXF1ZXN0ID0ganNvbnAuY3JlYXRlUmVxdWVzdCh0aGlzLl9qc29ucFBhcmFtKTtcbiAgICByZXR1cm4gKHBhcmFtcykgPT4ganNvbnBSZXF1ZXN0KHBhcmFtcyk7XG4gIH1cbn1cblxuLyoqXG4gKiBDbGFzcyBmb3IgU2ZkYyBDYW52YXMgcmVxdWVzdCB0cmFuc3BvcnRcbiAqL1xuZXhwb3J0IGNsYXNzIENhbnZhc1RyYW5zcG9ydCBleHRlbmRzIFRyYW5zcG9ydCB7XG4gIHN0YXRpYyBzdXBwb3J0ZWQ6IGJvb2xlYW4gPSBjYW52YXMuc3VwcG9ydGVkO1xuICBfc2lnbmVkUmVxdWVzdDogYW55O1xuXG4gIGNvbnN0cnVjdG9yKHNpZ25lZFJlcXVlc3Q6IGFueSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc2lnbmVkUmVxdWVzdCA9IHNpZ25lZFJlcXVlc3Q7XG4gIH1cblxuICBnZXRSZXF1ZXN0U3RyZWFtQ3JlYXRvcigpOiAoXG4gICAgcmVxOiBIdHRwUmVxdWVzdCxcbiAgICBvcHRpb25zOiBIdHRwUmVxdWVzdE9wdGlvbnMsXG4gICkgPT4gRHVwbGV4IHtcbiAgICBjb25zdCBjYW52YXNSZXF1ZXN0ID0gY2FudmFzLmNyZWF0ZVJlcXVlc3QodGhpcy5fc2lnbmVkUmVxdWVzdCk7XG4gICAgcmV0dXJuIChwYXJhbXMpID0+IGNhbnZhc1JlcXVlc3QocGFyYW1zKTtcbiAgfVxufVxuXG4vKiBAcHJpdmF0ZSAqL1xuZnVuY3Rpb24gY3JlYXRlWGRQcm94eVJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdCwgcHJveHlVcmw6IHN0cmluZyk6IEh0dHBSZXF1ZXN0IHtcbiAgY29uc3QgaGVhZGVyczogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIH0gPSB7XG4gICAgJ3NhbGVzZm9yY2Vwcm94eS1lbmRwb2ludCc6IHJlcS51cmwsXG4gIH07XG4gIGlmIChyZXEuaGVhZGVycykge1xuICAgIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhyZXEuaGVhZGVycykpIHtcbiAgICAgIGhlYWRlcnNbbmFtZV0gPSByZXEuaGVhZGVyc1tuYW1lXTtcbiAgICB9XG4gIH1cbiAgY29uc3Qgbm9jYWNoZSA9IGAke0RhdGUubm93KCl9LiR7U3RyaW5nKE1hdGgucmFuZG9tKCkpLnN1YnN0cmluZygyKX1gO1xuICByZXR1cm4ge1xuICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICB1cmw6IGAke3Byb3h5VXJsfT8ke25vY2FjaGV9YCxcbiAgICBoZWFkZXJzLFxuICAgIC4uLihyZXEuYm9keSAhPSBudWxsID8geyBib2R5OiByZXEuYm9keSB9IDoge30pLFxuICB9O1xufVxuXG4vKipcbiAqIENsYXNzIGZvciBIVFRQIHJlcXVlc3QgdHJhbnNwb3J0IHVzaW5nIGNyb3NzLWRvbWFpbiBBSkFYIHByb3h5IHNlcnZpY2VcbiAqL1xuZXhwb3J0IGNsYXNzIFhkUHJveHlUcmFuc3BvcnQgZXh0ZW5kcyBUcmFuc3BvcnQge1xuICBfeGRQcm94eVVybDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHhkUHJveHlVcmw6IHN0cmluZykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5feGRQcm94eVVybCA9IHhkUHJveHlVcmw7XG4gIH1cblxuICAvKipcbiAgICogTWFrZSBIVFRQIHJlcXVlc3QgdmlhIEFKQVggcHJveHlcbiAgICovXG4gIGh0dHBSZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3QsIF9vcHRpb25zOiBIdHRwUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHhkUHJveHlVcmwgPSB0aGlzLl94ZFByb3h5VXJsO1xuICAgIGNvbnN0IHsgdXJsLCBib2R5LCAuLi5ycmVxIH0gPSByZXE7XG4gICAgY29uc3QgY2Fub25pY2FsVXJsID0gdXJsLmluZGV4T2YoJy8nKSA9PT0gMCA/IGJhc2VVcmwgKyB1cmwgOiB1cmw7XG4gICAgY29uc3QgeGRQcm94eVJlcSA9IGNyZWF0ZVhkUHJveHlSZXF1ZXN0KFxuICAgICAgeyAuLi5ycmVxLCB1cmw6IGNhbm9uaWNhbFVybCwgYm9keSB9LFxuICAgICAgeGRQcm94eVVybCxcbiAgICApO1xuICAgIHJldHVybiBzdXBlci5odHRwUmVxdWVzdCh4ZFByb3h5UmVxLCB7XG4gICAgICBmb2xsb3dSZWRpcmVjdDogKHJlZGlyZWN0VXJsKSA9PlxuICAgICAgICBjcmVhdGVYZFByb3h5UmVxdWVzdChcbiAgICAgICAgICB7IC4uLnJyZXEsIG1ldGhvZDogJ0dFVCcsIHVybDogcmVkaXJlY3RVcmwgfSxcbiAgICAgICAgICB4ZFByb3h5VXJsLFxuICAgICAgICApLFxuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogQ2xhc3MgZm9yIEhUVFAgcmVxdWVzdCB0cmFuc3BvcnQgdXNpbmcgYSBwcm94eSBzZXJ2ZXJcbiAqL1xuZXhwb3J0IGNsYXNzIEh0dHBQcm94eVRyYW5zcG9ydCBleHRlbmRzIFRyYW5zcG9ydCB7XG4gIF9odHRwUHJveHk6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihodHRwUHJveHk6IHN0cmluZykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5faHR0cFByb3h5ID0gaHR0cFByb3h5O1xuICB9XG5cbiAgLyoqXG4gICAqIE1ha2UgSFRUUCByZXF1ZXN0IHZpYSBwcm94eSBzZXJ2ZXJcbiAgICovXG4gIGh0dHBSZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3QsIG9wdGlvbnNfOiBIdHRwUmVxdWVzdE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7IC4uLm9wdGlvbnNfLCBodHRwUHJveHk6IHRoaXMuX2h0dHBQcm94eSB9O1xuICAgIHJldHVybiBzdXBlci5odHRwUmVxdWVzdChyZXEsIG9wdGlvbnMpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRyYW5zcG9ydDtcbiJdfQ==