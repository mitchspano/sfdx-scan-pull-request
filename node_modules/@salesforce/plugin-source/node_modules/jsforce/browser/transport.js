import _Object$defineProperty from "@babel/runtime-corejs3/core-js-stable/object/define-property";
import _Object$defineProperties from "@babel/runtime-corejs3/core-js-stable/object/define-properties";
import _Object$getOwnPropertyDescriptors from "@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors";
import _forEachInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/for-each";
import _Object$getOwnPropertyDescriptor from "@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor";
import _filterInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/filter";
import _Object$getOwnPropertySymbols from "@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols";
import _Reflect$construct from "@babel/runtime-corejs3/core-js-stable/reflect/construct";
import "core-js/modules/es.regexp.exec";
import _indexOfInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/index-of";
import _objectWithoutProperties from "@babel/runtime-corejs3/helpers/objectWithoutProperties";
import _get from "@babel/runtime-corejs3/helpers/get";
import _Date$now from "@babel/runtime-corejs3/core-js-stable/date/now";
import _concatInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/concat";
import _Object$keys2 from "@babel/runtime-corejs3/core-js-stable/object/keys";
import _assertThisInitialized from "@babel/runtime-corejs3/helpers/assertThisInitialized";
import _inherits from "@babel/runtime-corejs3/helpers/inherits";
import _possibleConstructorReturn from "@babel/runtime-corejs3/helpers/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime-corejs3/helpers/getPrototypeOf";
import _defineProperty from "@babel/runtime-corejs3/helpers/defineProperty";
import _Promise from "@babel/runtime-corejs3/core-js-stable/promise";
import _classCallCheck from "@babel/runtime-corejs3/helpers/classCallCheck";
import _createClass from "@babel/runtime-corejs3/helpers/createClass";
import _parseInt from "@babel/runtime-corejs3/core-js-stable/parse-int";

var _process$env$HTTP_PRO;

function ownKeys(object, enumerableOnly) { var keys = _Object$keys2(object); if (_Object$getOwnPropertySymbols) { var symbols = _Object$getOwnPropertySymbols(object); if (enumerableOnly) symbols = _filterInstanceProperty(symbols).call(symbols, function (sym) { return _Object$getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { var _context3; _forEachInstanceProperty(_context3 = ownKeys(Object(source), true)).call(_context3, function (key) { _defineProperty(target, key, source[key]); }); } else if (_Object$getOwnPropertyDescriptors) { _Object$defineProperties(target, _Object$getOwnPropertyDescriptors(source)); } else { var _context4; _forEachInstanceProperty(_context4 = ownKeys(Object(source))).call(_context4, function (key) { _Object$defineProperty(target, key, _Object$getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = _Reflect$construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !_Reflect$construct) return false; if (_Reflect$construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(_Reflect$construct(Date, [], function () {})); return true; } catch (e) { return false; } }

/**
 *
 */
import request, { setDefaults } from './request';
import { StreamPromise } from './util/promise';
import jsonp from './browser/jsonp';
import canvas from './browser/canvas';
/**
 * Normarize Salesforce API host name
 * @private
 */

function normalizeApiHost(apiHost) {
  var m = /(\w+)\.(visual\.force|salesforce)\.com$/.exec(apiHost);

  if (m) {
    return "".concat(m[1], ".salesforce.com");
  }

  return apiHost;
}

setDefaults({
  httpProxy: (_process$env$HTTP_PRO = process.env.HTTP_PROXY) !== null && _process$env$HTTP_PRO !== void 0 ? _process$env$HTTP_PRO : undefined,
  timeout: process.env.HTTP_TIMEOUT ? _parseInt(process.env.HTTP_TIMEOUT, 10) : undefined
});
var baseUrl = typeof window !== 'undefined' && window.location && window.location.host ? "https://".concat(normalizeApiHost(window.location.host)) : process.env.LOCATION_BASE_URL || '';
/**
 * Class for HTTP request transport
 *
 * @class
 * @protected
 */

export var Transport = /*#__PURE__*/function () {
  function Transport() {
    _classCallCheck(this, Transport);
  }

  _createClass(Transport, [{
    key: "httpRequest",

    /**
     */
    value: function httpRequest(req) {
      var _this = this;

      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
      return StreamPromise.create(function () {
        var createStream = _this.getRequestStreamCreator();

        var stream = createStream(req, options);
        var promise = new _Promise(function (resolve, reject) {
          stream.on('complete', function (res) {
            return resolve(res);
          }).on('error', reject);
        });
        return {
          stream: stream,
          promise: promise
        };
      });
    }
    /**
     * @protected
     */

  }, {
    key: "getRequestStreamCreator",
    value: function getRequestStreamCreator() {
      return request;
    }
  }]);

  return Transport;
}();
/**
 * Class for JSONP request transport
 */

export var JsonpTransport = /*#__PURE__*/function (_Transport) {
  _inherits(JsonpTransport, _Transport);

  var _super = _createSuper(JsonpTransport);

  function JsonpTransport(jsonpParam) {
    var _this2;

    _classCallCheck(this, JsonpTransport);

    _this2 = _super.call(this);

    _defineProperty(_assertThisInitialized(_this2), "_jsonpParam", void 0);

    _this2._jsonpParam = jsonpParam;
    return _this2;
  }

  _createClass(JsonpTransport, [{
    key: "getRequestStreamCreator",
    value: function getRequestStreamCreator() {
      var jsonpRequest = jsonp.createRequest(this._jsonpParam);
      return function (params) {
        return jsonpRequest(params);
      };
    }
  }]);

  return JsonpTransport;
}(Transport);
/**
 * Class for Sfdc Canvas request transport
 */

_defineProperty(JsonpTransport, "supprted", jsonp.supported);

export var CanvasTransport = /*#__PURE__*/function (_Transport2) {
  _inherits(CanvasTransport, _Transport2);

  var _super2 = _createSuper(CanvasTransport);

  function CanvasTransport(signedRequest) {
    var _this3;

    _classCallCheck(this, CanvasTransport);

    _this3 = _super2.call(this);

    _defineProperty(_assertThisInitialized(_this3), "_signedRequest", void 0);

    _this3._signedRequest = signedRequest;
    return _this3;
  }

  _createClass(CanvasTransport, [{
    key: "getRequestStreamCreator",
    value: function getRequestStreamCreator() {
      var canvasRequest = canvas.createRequest(this._signedRequest);
      return function (params) {
        return canvasRequest(params);
      };
    }
  }]);

  return CanvasTransport;
}(Transport);
/* @private */

_defineProperty(CanvasTransport, "supported", canvas.supported);

function createXdProxyRequest(req, proxyUrl) {
  var _context, _context2;

  var headers = {
    'salesforceproxy-endpoint': req.url
  };

  if (req.headers) {
    for (var _i = 0, _Object$keys = _Object$keys2(req.headers); _i < _Object$keys.length; _i++) {
      var _name = _Object$keys[_i];
      headers[_name] = req.headers[_name];
    }
  }

  var nocache = _concatInstanceProperty(_context = "".concat(_Date$now(), ".")).call(_context, String(Math.random()).substring(2));

  return _objectSpread({
    method: req.method,
    url: _concatInstanceProperty(_context2 = "".concat(proxyUrl, "?")).call(_context2, nocache),
    headers: headers
  }, req.body != null ? {
    body: req.body
  } : {});
}
/**
 * Class for HTTP request transport using cross-domain AJAX proxy service
 */


export var XdProxyTransport = /*#__PURE__*/function (_Transport3) {
  _inherits(XdProxyTransport, _Transport3);

  var _super3 = _createSuper(XdProxyTransport);

  function XdProxyTransport(xdProxyUrl) {
    var _this4;

    _classCallCheck(this, XdProxyTransport);

    _this4 = _super3.call(this);

    _defineProperty(_assertThisInitialized(_this4), "_xdProxyUrl", void 0);

    _this4._xdProxyUrl = xdProxyUrl;
    return _this4;
  }
  /**
   * Make HTTP request via AJAX proxy
   */


  _createClass(XdProxyTransport, [{
    key: "httpRequest",
    value: function httpRequest(req) {
      var _options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var xdProxyUrl = this._xdProxyUrl;

      var url = req.url,
          body = req.body,
          rreq = _objectWithoutProperties(req, ["url", "body"]);

      var canonicalUrl = _indexOfInstanceProperty(url).call(url, '/') === 0 ? baseUrl + url : url;
      var xdProxyReq = createXdProxyRequest(_objectSpread(_objectSpread({}, rreq), {}, {
        url: canonicalUrl,
        body: body
      }), xdProxyUrl);
      return _get(_getPrototypeOf(XdProxyTransport.prototype), "httpRequest", this).call(this, xdProxyReq, {
        followRedirect: function followRedirect(redirectUrl) {
          return createXdProxyRequest(_objectSpread(_objectSpread({}, rreq), {}, {
            method: 'GET',
            url: redirectUrl
          }), xdProxyUrl);
        }
      });
    }
  }]);

  return XdProxyTransport;
}(Transport);
/**
 * Class for HTTP request transport using a proxy server
 */

export var HttpProxyTransport = /*#__PURE__*/function (_Transport4) {
  _inherits(HttpProxyTransport, _Transport4);

  var _super4 = _createSuper(HttpProxyTransport);

  function HttpProxyTransport(httpProxy) {
    var _this5;

    _classCallCheck(this, HttpProxyTransport);

    _this5 = _super4.call(this);

    _defineProperty(_assertThisInitialized(_this5), "_httpProxy", void 0);

    _this5._httpProxy = httpProxy;
    return _this5;
  }
  /**
   * Make HTTP request via proxy server
   */


  _createClass(HttpProxyTransport, [{
    key: "httpRequest",
    value: function httpRequest(req) {
      var options_ = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var options = _objectSpread(_objectSpread({}, options_), {}, {
        httpProxy: this._httpProxy
      });

      return _get(_getPrototypeOf(HttpProxyTransport.prototype), "httpRequest", this).call(this, req, options);
    }
  }]);

  return HttpProxyTransport;
}(Transport);
export default Transport;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmFuc3BvcnQudHMiXSwibmFtZXMiOlsicmVxdWVzdCIsInNldERlZmF1bHRzIiwiU3RyZWFtUHJvbWlzZSIsImpzb25wIiwiY2FudmFzIiwibm9ybWFsaXplQXBpSG9zdCIsImFwaUhvc3QiLCJtIiwiZXhlYyIsImh0dHBQcm94eSIsInByb2Nlc3MiLCJlbnYiLCJIVFRQX1BST1hZIiwidW5kZWZpbmVkIiwidGltZW91dCIsIkhUVFBfVElNRU9VVCIsImJhc2VVcmwiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsImhvc3QiLCJMT0NBVElPTl9CQVNFX1VSTCIsIlRyYW5zcG9ydCIsInJlcSIsIm9wdGlvbnMiLCJjcmVhdGUiLCJjcmVhdGVTdHJlYW0iLCJnZXRSZXF1ZXN0U3RyZWFtQ3JlYXRvciIsInN0cmVhbSIsInByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwib24iLCJyZXMiLCJKc29ucFRyYW5zcG9ydCIsImpzb25wUGFyYW0iLCJfanNvbnBQYXJhbSIsImpzb25wUmVxdWVzdCIsImNyZWF0ZVJlcXVlc3QiLCJwYXJhbXMiLCJzdXBwb3J0ZWQiLCJDYW52YXNUcmFuc3BvcnQiLCJzaWduZWRSZXF1ZXN0IiwiX3NpZ25lZFJlcXVlc3QiLCJjYW52YXNSZXF1ZXN0IiwiY3JlYXRlWGRQcm94eVJlcXVlc3QiLCJwcm94eVVybCIsImhlYWRlcnMiLCJ1cmwiLCJuYW1lIiwibm9jYWNoZSIsIlN0cmluZyIsIk1hdGgiLCJyYW5kb20iLCJzdWJzdHJpbmciLCJtZXRob2QiLCJib2R5IiwiWGRQcm94eVRyYW5zcG9ydCIsInhkUHJveHlVcmwiLCJfeGRQcm94eVVybCIsIl9vcHRpb25zIiwicnJlcSIsImNhbm9uaWNhbFVybCIsInhkUHJveHlSZXEiLCJmb2xsb3dSZWRpcmVjdCIsInJlZGlyZWN0VXJsIiwiSHR0cFByb3h5VHJhbnNwb3J0IiwiX2h0dHBQcm94eSIsIm9wdGlvbnNfIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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QTFCSDs7QUFBQTtBQUFBLEVBQXNDcEMsU0FBdEM7QUE2QkE7QUFDQTtBQUNBOztBQUNBLFdBQWE0QyxrQkFBYjtBQUFBOztBQUFBOztBQUdFLDhCQUFZeEQsU0FBWixFQUErQjtBQUFBOztBQUFBOztBQUM3Qjs7QUFENkI7O0FBRTdCLFdBQUt5RCxVQUFMLEdBQWtCekQsU0FBbEI7QUFGNkI7QUFHOUI7QUFFRDtBQUNGO0FBQ0E7OztBQVZBO0FBQUE7QUFBQSxnQ0FXY2EsR0FYZCxFQVdtRTtBQUFBLFVBQW5DNkMsUUFBbUMsdUVBQUosRUFBSTs7QUFDL0QsVUFBTTVDLE9BQU8sbUNBQVE0QyxRQUFSO0FBQWtCMUQsUUFBQUEsU0FBUyxFQUFFLEtBQUt5RDtBQUFsQyxRQUFiOztBQUNBLGlHQUF5QjVDLEdBQXpCLEVBQThCQyxPQUE5QjtBQUNEO0FBZEg7O0FBQUE7QUFBQSxFQUF3Q0YsU0FBeEM7QUFpQkEsZUFBZUEsU0FBZiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqL1xuaW1wb3J0IHsgRHVwbGV4IH0gZnJvbSAnc3RyZWFtJztcbmltcG9ydCByZXF1ZXN0LCB7IHNldERlZmF1bHRzIH0gZnJvbSAnLi9yZXF1ZXN0JztcbmltcG9ydCB7IEh0dHBSZXF1ZXN0LCBIdHRwUmVxdWVzdE9wdGlvbnMsIEh0dHBSZXNwb25zZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgU3RyZWFtUHJvbWlzZSB9IGZyb20gJy4vdXRpbC9wcm9taXNlJztcbmltcG9ydCBqc29ucCBmcm9tICcuL2Jyb3dzZXIvanNvbnAnO1xuaW1wb3J0IGNhbnZhcyBmcm9tICcuL2Jyb3dzZXIvY2FudmFzJztcblxuLyoqXG4gKiBOb3JtYXJpemUgU2FsZXNmb3JjZSBBUEkgaG9zdCBuYW1lXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBub3JtYWxpemVBcGlIb3N0KGFwaUhvc3Q6IHN0cmluZykge1xuICBjb25zdCBtID0gLyhcXHcrKVxcLih2aXN1YWxcXC5mb3JjZXxzYWxlc2ZvcmNlKVxcLmNvbSQvLmV4ZWMoYXBpSG9zdCk7XG4gIGlmIChtKSB7XG4gICAgcmV0dXJuIGAke21bMV19LnNhbGVzZm9yY2UuY29tYDtcbiAgfVxuICByZXR1cm4gYXBpSG9zdDtcbn1cblxuc2V0RGVmYXVsdHMoe1xuICBodHRwUHJveHk6IHByb2Nlc3MuZW52LkhUVFBfUFJPWFkgPz8gdW5kZWZpbmVkLFxuICB0aW1lb3V0OiBwcm9jZXNzLmVudi5IVFRQX1RJTUVPVVRcbiAgICA/IHBhcnNlSW50KHByb2Nlc3MuZW52LkhUVFBfVElNRU9VVCwgMTApXG4gICAgOiB1bmRlZmluZWQsXG59KTtcblxuY29uc3QgYmFzZVVybCA9XG4gIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaG9zdFxuICAgID8gYGh0dHBzOi8vJHtub3JtYWxpemVBcGlIb3N0KHdpbmRvdy5sb2NhdGlvbi5ob3N0KX1gXG4gICAgOiBwcm9jZXNzLmVudi5MT0NBVElPTl9CQVNFX1VSTCB8fCAnJztcblxuLyoqXG4gKiBDbGFzcyBmb3IgSFRUUCByZXF1ZXN0IHRyYW5zcG9ydFxuICpcbiAqIEBjbGFzc1xuICogQHByb3RlY3RlZFxuICovXG5leHBvcnQgY2xhc3MgVHJhbnNwb3J0IHtcbiAgLyoqXG4gICAqL1xuICBodHRwUmVxdWVzdChcbiAgICByZXE6IEh0dHBSZXF1ZXN0LFxuICAgIG9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucyA9IHt9LFxuICApOiBTdHJlYW1Qcm9taXNlPEh0dHBSZXNwb25zZT4ge1xuICAgIHJldHVybiBTdHJlYW1Qcm9taXNlLmNyZWF0ZSgoKSA9PiB7XG4gICAgICBjb25zdCBjcmVhdGVTdHJlYW0gPSB0aGlzLmdldFJlcXVlc3RTdHJlYW1DcmVhdG9yKCk7XG4gICAgICBjb25zdCBzdHJlYW0gPSBjcmVhdGVTdHJlYW0ocmVxLCBvcHRpb25zKTtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZTxIdHRwUmVzcG9uc2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgc3RyZWFtXG4gICAgICAgICAgLm9uKCdjb21wbGV0ZScsIChyZXM6IEh0dHBSZXNwb25zZSkgPT4gcmVzb2x2ZShyZXMpKVxuICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4geyBzdHJlYW0sIHByb21pc2UgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJvdGVjdGVkXG4gICAqL1xuICBnZXRSZXF1ZXN0U3RyZWFtQ3JlYXRvcigpOiAoXG4gICAgcmVxOiBIdHRwUmVxdWVzdCxcbiAgICBvcHRpb25zOiBIdHRwUmVxdWVzdE9wdGlvbnMsXG4gICkgPT4gRHVwbGV4IHtcbiAgICByZXR1cm4gcmVxdWVzdDtcbiAgfVxufVxuXG4vKipcbiAqIENsYXNzIGZvciBKU09OUCByZXF1ZXN0IHRyYW5zcG9ydFxuICovXG5leHBvcnQgY2xhc3MgSnNvbnBUcmFuc3BvcnQgZXh0ZW5kcyBUcmFuc3BvcnQge1xuICBzdGF0aWMgc3VwcHJ0ZWQ6IGJvb2xlYW4gPSBqc29ucC5zdXBwb3J0ZWQ7XG4gIF9qc29ucFBhcmFtOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoanNvbnBQYXJhbTogc3RyaW5nKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9qc29ucFBhcmFtID0ganNvbnBQYXJhbTtcbiAgfVxuXG4gIGdldFJlcXVlc3RTdHJlYW1DcmVhdG9yKCk6IChcbiAgICByZXE6IEh0dHBSZXF1ZXN0LFxuICAgIG9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucyxcbiAgKSA9PiBEdXBsZXgge1xuICAgIGNvbnN0IGpzb25wUmVxdWVzdCA9IGpzb25wLmNyZWF0ZVJlcXVlc3QodGhpcy5fanNvbnBQYXJhbSk7XG4gICAgcmV0dXJuIChwYXJhbXMpID0+IGpzb25wUmVxdWVzdChwYXJhbXMpO1xuICB9XG59XG5cbi8qKlxuICogQ2xhc3MgZm9yIFNmZGMgQ2FudmFzIHJlcXVlc3QgdHJhbnNwb3J0XG4gKi9cbmV4cG9ydCBjbGFzcyBDYW52YXNUcmFuc3BvcnQgZXh0ZW5kcyBUcmFuc3BvcnQge1xuICBzdGF0aWMgc3VwcG9ydGVkOiBib29sZWFuID0gY2FudmFzLnN1cHBvcnRlZDtcbiAgX3NpZ25lZFJlcXVlc3Q6IGFueTtcblxuICBjb25zdHJ1Y3RvcihzaWduZWRSZXF1ZXN0OiBhbnkpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NpZ25lZFJlcXVlc3QgPSBzaWduZWRSZXF1ZXN0O1xuICB9XG5cbiAgZ2V0UmVxdWVzdFN0cmVhbUNyZWF0b3IoKTogKFxuICAgIHJlcTogSHR0cFJlcXVlc3QsXG4gICAgb3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zLFxuICApID0+IER1cGxleCB7XG4gICAgY29uc3QgY2FudmFzUmVxdWVzdCA9IGNhbnZhcy5jcmVhdGVSZXF1ZXN0KHRoaXMuX3NpZ25lZFJlcXVlc3QpO1xuICAgIHJldHVybiAocGFyYW1zKSA9PiBjYW52YXNSZXF1ZXN0KHBhcmFtcyk7XG4gIH1cbn1cblxuLyogQHByaXZhdGUgKi9cbmZ1bmN0aW9uIGNyZWF0ZVhkUHJveHlSZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3QsIHByb3h5VXJsOiBzdHJpbmcpOiBIdHRwUmVxdWVzdCB7XG4gIGNvbnN0IGhlYWRlcnM6IHsgW25hbWU6IHN0cmluZ106IHN0cmluZyB9ID0ge1xuICAgICdzYWxlc2ZvcmNlcHJveHktZW5kcG9pbnQnOiByZXEudXJsLFxuICB9O1xuICBpZiAocmVxLmhlYWRlcnMpIHtcbiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMocmVxLmhlYWRlcnMpKSB7XG4gICAgICBoZWFkZXJzW25hbWVdID0gcmVxLmhlYWRlcnNbbmFtZV07XG4gICAgfVxuICB9XG4gIGNvbnN0IG5vY2FjaGUgPSBgJHtEYXRlLm5vdygpfS4ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zdWJzdHJpbmcoMil9YDtcbiAgcmV0dXJuIHtcbiAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgdXJsOiBgJHtwcm94eVVybH0/JHtub2NhY2hlfWAsXG4gICAgaGVhZGVycyxcbiAgICAuLi4ocmVxLmJvZHkgIT0gbnVsbCA/IHsgYm9keTogcmVxLmJvZHkgfSA6IHt9KSxcbiAgfTtcbn1cblxuLyoqXG4gKiBDbGFzcyBmb3IgSFRUUCByZXF1ZXN0IHRyYW5zcG9ydCB1c2luZyBjcm9zcy1kb21haW4gQUpBWCBwcm94eSBzZXJ2aWNlXG4gKi9cbmV4cG9ydCBjbGFzcyBYZFByb3h5VHJhbnNwb3J0IGV4dGVuZHMgVHJhbnNwb3J0IHtcbiAgX3hkUHJveHlVcmw6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcih4ZFByb3h5VXJsOiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3hkUHJveHlVcmwgPSB4ZFByb3h5VXJsO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ha2UgSFRUUCByZXF1ZXN0IHZpYSBBSkFYIHByb3h5XG4gICAqL1xuICBodHRwUmVxdWVzdChyZXE6IEh0dHBSZXF1ZXN0LCBfb3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCB4ZFByb3h5VXJsID0gdGhpcy5feGRQcm94eVVybDtcbiAgICBjb25zdCB7IHVybCwgYm9keSwgLi4ucnJlcSB9ID0gcmVxO1xuICAgIGNvbnN0IGNhbm9uaWNhbFVybCA9IHVybC5pbmRleE9mKCcvJykgPT09IDAgPyBiYXNlVXJsICsgdXJsIDogdXJsO1xuICAgIGNvbnN0IHhkUHJveHlSZXEgPSBjcmVhdGVYZFByb3h5UmVxdWVzdChcbiAgICAgIHsgLi4ucnJlcSwgdXJsOiBjYW5vbmljYWxVcmwsIGJvZHkgfSxcbiAgICAgIHhkUHJveHlVcmwsXG4gICAgKTtcbiAgICByZXR1cm4gc3VwZXIuaHR0cFJlcXVlc3QoeGRQcm94eVJlcSwge1xuICAgICAgZm9sbG93UmVkaXJlY3Q6IChyZWRpcmVjdFVybCkgPT5cbiAgICAgICAgY3JlYXRlWGRQcm94eVJlcXVlc3QoXG4gICAgICAgICAgeyAuLi5ycmVxLCBtZXRob2Q6ICdHRVQnLCB1cmw6IHJlZGlyZWN0VXJsIH0sXG4gICAgICAgICAgeGRQcm94eVVybCxcbiAgICAgICAgKSxcbiAgICB9KTtcbiAgfVxufVxuXG4vKipcbiAqIENsYXNzIGZvciBIVFRQIHJlcXVlc3QgdHJhbnNwb3J0IHVzaW5nIGEgcHJveHkgc2VydmVyXG4gKi9cbmV4cG9ydCBjbGFzcyBIdHRwUHJveHlUcmFuc3BvcnQgZXh0ZW5kcyBUcmFuc3BvcnQge1xuICBfaHR0cFByb3h5OiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoaHR0cFByb3h5OiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2h0dHBQcm94eSA9IGh0dHBQcm94eTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYWtlIEhUVFAgcmVxdWVzdCB2aWEgcHJveHkgc2VydmVyXG4gICAqL1xuICBodHRwUmVxdWVzdChyZXE6IEh0dHBSZXF1ZXN0LCBvcHRpb25zXzogSHR0cFJlcXVlc3RPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBvcHRpb25zID0geyAuLi5vcHRpb25zXywgaHR0cFByb3h5OiB0aGlzLl9odHRwUHJveHkgfTtcbiAgICByZXR1cm4gc3VwZXIuaHR0cFJlcXVlc3QocmVxLCBvcHRpb25zKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBUcmFuc3BvcnQ7XG4iXX0=