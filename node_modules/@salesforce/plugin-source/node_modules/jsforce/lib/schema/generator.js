"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.promise");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.default = main;

var _promise = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/promise"));

var _stringify = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/json/stringify"));

var _os = _interopRequireDefault(require("os"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _cli = require("../cli/cli");

var _ = require("..");

var _commander = require("commander");

function getCacheFileDir() {
  return _path.default.join(_os.default.tmpdir(), 'jsforce-gen-schema-cache');
}

function getCacheFilePath(orgId) {
  return _path.default.join(getCacheFileDir(), orgId, 'describe.json');
}

async function readDescribedCache(orgId) {
  try {
    const cacheFile = getCacheFilePath(orgId);
    const data = await _fsExtra.default.readFile(cacheFile, 'utf8');
    return JSON.parse(data);
  } catch (e) {
    return null;
  }
}

async function loadDescribeResult(conn, orgId, cache) {
  console.info('describing global');
  const {
    sobjects: sos
  } = await conn.describeGlobal();
  const sobjects = [];

  for (const {
    name
  } of sos) {
    console.info('describing ' + name);
    const so = await conn.describe(name);
    sobjects.push(so);
  }

  if (cache) {
    const cacheFile = getCacheFilePath(orgId);
    await _fsExtra.default.outputFile(cacheFile, (0, _stringify.default)(sobjects, null, 2), 'utf8');
  }

  return sobjects;
}

function getParentReferences(sobject) {
  const parentReferences = [];

  for (const {
    type,
    nillable,
    relationshipName,
    referenceTo
  } of sobject.fields) {
    if (type === 'reference' && relationshipName && referenceTo && referenceTo.length > 0) {
      const parentSObject = referenceTo.length > 1 ? 'Name' : referenceTo[0];
      parentReferences.push({
        nillable,
        parentSObject,
        relationshipName
      });
    }
  }

  return parentReferences;
}

function getTSTypeString(type) {
  return type === 'double' || type === 'int' || type === 'currency' || type === 'percent' ? 'number' : type === 'boolean' ? 'boolean' : type === 'date' || type === 'datetime' || type === 'time' ? 'DateString' : type === 'base64' ? 'BlobString' : type === 'address' ? 'Address' : type === 'complexvalue' ? 'any' : 'string';
}

async function dumpSchema(conn, orgId, outputFile, schemaName, cache) {
  const sobjects = (cache ? await readDescribedCache(orgId) : null) || (await loadDescribeResult(conn, orgId, cache));
  await _fsExtra.default.ensureFile(outputFile);

  const out = _fsExtra.default.createWriteStream(outputFile, 'utf8');

  return new _promise.default((resolve, reject) => {
    out.on('error', err => reject(err));
    out.on('finish', resolve);

    const writeLine = message => out.write(message + '\n');

    writeLine("import { Schema, SObjectDefinition, DateString, BlobString, Address } from 'jsforce';");
    writeLine('');

    for (const sobject of sobjects) {
      const {
        name,
        fields,
        childRelationships
      } = sobject;
      writeLine(`type Fields$${name} = {`);
      writeLine('  //');

      for (const {
        name,
        type,
        nillable
      } of fields) {
        const tsType = getTSTypeString(type);
        const orNull = nillable ? ' | null' : '';
        writeLine(`  ${name}: ${tsType}${orNull};`);
      }

      writeLine('};');
      writeLine('');
      writeLine(`type ParentReferences$${name} = {`);
      writeLine('  //');
      const parentReferences = getParentReferences(sobject);

      for (const {
        nillable,
        parentSObject,
        relationshipName
      } of parentReferences) {
        const orNull = nillable ? ' | null' : '';
        writeLine(`  ${relationshipName}: SObjectDefinition$${parentSObject}${orNull};`);
      }

      writeLine('};');
      writeLine('');
      writeLine(`type ChildRelationships$${name} = {`);
      writeLine('  //');

      for (const {
        field,
        childSObject,
        relationshipName
      } of childRelationships) {
        if (field && childSObject && relationshipName && !/__c$/.test(field)) {
          writeLine(`  ${relationshipName}: SObjectDefinition$${childSObject};`);
        }
      }

      writeLine('};');
      writeLine('');
      writeLine(`interface SObjectDefinition$${name} extends SObjectDefinition<'${name}'> {
    Name: '${name}';
    Fields: Fields$${name};
    ParentReferences: ParentReferences$${name};
    ChildRelationships: ChildRelationships$${name};
  }`);
      writeLine('');
    }

    writeLine('');
    writeLine(`export interface ${schemaName} extends Schema {`);
    writeLine('  SObjects: {');

    for (const {
      name
    } of sobjects) {
      writeLine(`    ${name}: SObjectDefinition$${name};`);
    }

    writeLine('  };');
    writeLine('}');
    out.end();
  });
}

/**
 *
 */
function readCommand() {
  return new _commander.Command().option('-u, --username [username]', 'Salesforce username').option('-p, --password [password]', 'Salesforce password (and security token, if available)').option('-c, --connection [connection]', 'Connection name stored in connection registry').option('-l, --loginUrl [loginUrl]', 'Salesforce login url').option('-n, --schemaName [schemaName]', 'Name of schema type', 'MySchema').requiredOption('-o, --outputFile <outputFile>', 'Generated schema file path', './schema.d.ts').option('--sandbox', 'Login to Salesforce sandbox').option('--no-cache', 'Do not generate cache file for described result in tmp directory').option('--clearCache', 'Clear all existing described cache files').version(_.VERSION).parse(process.argv);
}
/**
 *
 */


async function main() {
  const program = readCommand();
  const cli = new _cli.Cli();
  await cli.connect(program);
  const conn = cli.getCurrentConnection();

  if (!conn.userInfo) {
    console.error('Cannot connect to Salesforce');
    return;
  }

  await dumpSchema(conn, conn.userInfo.organizationId, program.outputFile, program.schemaName, program.cache);

  if (program.clearCache) {
    console.log('removing cache files');
    await _fsExtra.default.remove(getCacheFileDir());
  }

  console.log(`Dumped to: ${program.outputFile}`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY2hlbWEvZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbImdldENhY2hlRmlsZURpciIsInBhdGgiLCJqb2luIiwib3MiLCJ0bXBkaXIiLCJnZXRDYWNoZUZpbGVQYXRoIiwib3JnSWQiLCJyZWFkRGVzY3JpYmVkQ2FjaGUiLCJjYWNoZUZpbGUiLCJkYXRhIiwiZnMiLCJyZWFkRmlsZSIsIkpTT04iLCJwYXJzZSIsImUiLCJsb2FkRGVzY3JpYmVSZXN1bHQiLCJjb25uIiwiY2FjaGUiLCJjb25zb2xlIiwiaW5mbyIsInNvYmplY3RzIiwic29zIiwiZGVzY3JpYmVHbG9iYWwiLCJuYW1lIiwic28iLCJkZXNjcmliZSIsInB1c2giLCJvdXRwdXRGaWxlIiwiZ2V0UGFyZW50UmVmZXJlbmNlcyIsInNvYmplY3QiLCJwYXJlbnRSZWZlcmVuY2VzIiwidHlwZSIsIm5pbGxhYmxlIiwicmVsYXRpb25zaGlwTmFtZSIsInJlZmVyZW5jZVRvIiwiZmllbGRzIiwibGVuZ3RoIiwicGFyZW50U09iamVjdCIsImdldFRTVHlwZVN0cmluZyIsImR1bXBTY2hlbWEiLCJzY2hlbWFOYW1lIiwiZW5zdXJlRmlsZSIsIm91dCIsImNyZWF0ZVdyaXRlU3RyZWFtIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uIiwiZXJyIiwid3JpdGVMaW5lIiwibWVzc2FnZSIsIndyaXRlIiwiY2hpbGRSZWxhdGlvbnNoaXBzIiwidHNUeXBlIiwib3JOdWxsIiwiZmllbGQiLCJjaGlsZFNPYmplY3QiLCJ0ZXN0IiwiZW5kIiwicmVhZENvbW1hbmQiLCJDb21tYW5kIiwib3B0aW9uIiwicmVxdWlyZWRPcHRpb24iLCJ2ZXJzaW9uIiwiVkVSU0lPTiIsInByb2Nlc3MiLCJhcmd2IiwibWFpbiIsInByb2dyYW0iLCJjbGkiLCJDbGkiLCJjb25uZWN0IiwiZ2V0Q3VycmVudENvbm5lY3Rpb24iLCJ1c2VySW5mbyIsImVycm9yIiwib3JnYW5pemF0aW9uSWQiLCJjbGVhckNhY2hlIiwibG9n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Q2xELEtBTE0sQ0FBaEI7O0FBT0EsTUFBSWtELE9BQU8sQ0FBQ1EsVUFBWixFQUF3QjtBQUN0QnpELElBQUFBLE9BQU8sQ0FBQzBELEdBQVIsQ0FBWSxzQkFBWjtBQUNBLFVBQU1sRSxpQkFBR21FLE1BQUgsQ0FBVTdFLGVBQWUsRUFBekIsQ0FBTjtBQUNEOztBQUNEa0IsRUFBQUEsT0FBTyxDQUFDMEQsR0FBUixDQUFhLGNBQWFULE9BQU8sQ0FBQ3hDLFVBQVcsRUFBN0M7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBEZXNjcmliZVNPYmplY3RSZXN1bHQgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBDbGkgfSBmcm9tICcuLi9jbGkvY2xpJztcbmltcG9ydCB7IENvbm5lY3Rpb24sIFZFUlNJT04gfSBmcm9tICcuLic7XG5pbXBvcnQgeyBDb21tYW5kIH0gZnJvbSAnY29tbWFuZGVyJztcblxudHlwZSBVbndyYXBQcm9taXNlPFQ+ID0gVCBleHRlbmRzIFByb21pc2U8aW5mZXIgVT4gPyBVIDogbmV2ZXI7XG5cbmZ1bmN0aW9uIGdldENhY2hlRmlsZURpcigpIHtcbiAgcmV0dXJuIHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2pzZm9yY2UtZ2VuLXNjaGVtYS1jYWNoZScpO1xufVxuXG5mdW5jdGlvbiBnZXRDYWNoZUZpbGVQYXRoKG9yZ0lkOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHBhdGguam9pbihnZXRDYWNoZUZpbGVEaXIoKSwgb3JnSWQsICdkZXNjcmliZS5qc29uJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlYWREZXNjcmliZWRDYWNoZShcbiAgb3JnSWQ6IHN0cmluZyxcbik6IFByb21pc2U8VW53cmFwUHJvbWlzZTxSZXR1cm5UeXBlPHR5cGVvZiBsb2FkRGVzY3JpYmVSZXN1bHQ+PiB8IG51bGw+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjYWNoZUZpbGUgPSBnZXRDYWNoZUZpbGVQYXRoKG9yZ0lkKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGUoY2FjaGVGaWxlLCAndXRmOCcpO1xuICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9hZERlc2NyaWJlUmVzdWx0KFxuICBjb25uOiBDb25uZWN0aW9uLFxuICBvcmdJZDogc3RyaW5nLFxuICBjYWNoZT86IGJvb2xlYW4sXG4pIHtcbiAgY29uc29sZS5pbmZvKCdkZXNjcmliaW5nIGdsb2JhbCcpO1xuICBjb25zdCB7IHNvYmplY3RzOiBzb3MgfSA9IGF3YWl0IGNvbm4uZGVzY3JpYmVHbG9iYWwoKTtcbiAgY29uc3Qgc29iamVjdHMgPSBbXTtcbiAgZm9yIChjb25zdCB7IG5hbWUgfSBvZiBzb3MpIHtcbiAgICBjb25zb2xlLmluZm8oJ2Rlc2NyaWJpbmcgJyArIG5hbWUpO1xuICAgIGNvbnN0IHNvID0gYXdhaXQgY29ubi5kZXNjcmliZShuYW1lKTtcbiAgICBzb2JqZWN0cy5wdXNoKHNvKTtcbiAgfVxuICBpZiAoY2FjaGUpIHtcbiAgICBjb25zdCBjYWNoZUZpbGUgPSBnZXRDYWNoZUZpbGVQYXRoKG9yZ0lkKTtcbiAgICBhd2FpdCBmcy5vdXRwdXRGaWxlKGNhY2hlRmlsZSwgSlNPTi5zdHJpbmdpZnkoc29iamVjdHMsIG51bGwsIDIpLCAndXRmOCcpO1xuICB9XG4gIHJldHVybiBzb2JqZWN0cztcbn1cblxuZnVuY3Rpb24gZ2V0UGFyZW50UmVmZXJlbmNlcyhzb2JqZWN0OiBEZXNjcmliZVNPYmplY3RSZXN1bHQpIHtcbiAgY29uc3QgcGFyZW50UmVmZXJlbmNlcyA9IFtdO1xuICBmb3IgKGNvbnN0IHtcbiAgICB0eXBlLFxuICAgIG5pbGxhYmxlLFxuICAgIHJlbGF0aW9uc2hpcE5hbWUsXG4gICAgcmVmZXJlbmNlVG8sXG4gIH0gb2Ygc29iamVjdC5maWVsZHMpIHtcbiAgICBpZiAoXG4gICAgICB0eXBlID09PSAncmVmZXJlbmNlJyAmJlxuICAgICAgcmVsYXRpb25zaGlwTmFtZSAmJlxuICAgICAgcmVmZXJlbmNlVG8gJiZcbiAgICAgIHJlZmVyZW5jZVRvLmxlbmd0aCA+IDBcbiAgICApIHtcbiAgICAgIGNvbnN0IHBhcmVudFNPYmplY3QgPSByZWZlcmVuY2VUby5sZW5ndGggPiAxID8gJ05hbWUnIDogcmVmZXJlbmNlVG9bMF07XG4gICAgICBwYXJlbnRSZWZlcmVuY2VzLnB1c2goeyBuaWxsYWJsZSwgcGFyZW50U09iamVjdCwgcmVsYXRpb25zaGlwTmFtZSB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHBhcmVudFJlZmVyZW5jZXM7XG59XG5cbmZ1bmN0aW9uIGdldFRTVHlwZVN0cmluZyh0eXBlOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gdHlwZSA9PT0gJ2RvdWJsZScgfHxcbiAgICB0eXBlID09PSAnaW50JyB8fFxuICAgIHR5cGUgPT09ICdjdXJyZW5jeScgfHxcbiAgICB0eXBlID09PSAncGVyY2VudCdcbiAgICA/ICdudW1iZXInXG4gICAgOiB0eXBlID09PSAnYm9vbGVhbidcbiAgICA/ICdib29sZWFuJ1xuICAgIDogdHlwZSA9PT0gJ2RhdGUnIHx8IHR5cGUgPT09ICdkYXRldGltZScgfHwgdHlwZSA9PT0gJ3RpbWUnXG4gICAgPyAnRGF0ZVN0cmluZydcbiAgICA6IHR5cGUgPT09ICdiYXNlNjQnXG4gICAgPyAnQmxvYlN0cmluZydcbiAgICA6IHR5cGUgPT09ICdhZGRyZXNzJ1xuICAgID8gJ0FkZHJlc3MnXG4gICAgOiB0eXBlID09PSAnY29tcGxleHZhbHVlJ1xuICAgID8gJ2FueSdcbiAgICA6ICdzdHJpbmcnO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkdW1wU2NoZW1hKFxuICBjb25uOiBDb25uZWN0aW9uLFxuICBvcmdJZDogc3RyaW5nLFxuICBvdXRwdXRGaWxlOiBzdHJpbmcsXG4gIHNjaGVtYU5hbWU6IHN0cmluZyxcbiAgY2FjaGU/OiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IHNvYmplY3RzID1cbiAgICAoY2FjaGUgPyBhd2FpdCByZWFkRGVzY3JpYmVkQ2FjaGUob3JnSWQpIDogbnVsbCkgfHxcbiAgICAoYXdhaXQgbG9hZERlc2NyaWJlUmVzdWx0KGNvbm4sIG9yZ0lkLCBjYWNoZSkpO1xuICBhd2FpdCBmcy5lbnN1cmVGaWxlKG91dHB1dEZpbGUpO1xuICBjb25zdCBvdXQgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShvdXRwdXRGaWxlLCAndXRmOCcpO1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIG91dC5vbignZXJyb3InLCAoZXJyKSA9PiByZWplY3QoZXJyKSk7XG4gICAgb3V0Lm9uKCdmaW5pc2gnLCByZXNvbHZlKTtcbiAgICBjb25zdCB3cml0ZUxpbmUgPSAobWVzc2FnZTogc3RyaW5nKSA9PiBvdXQud3JpdGUobWVzc2FnZSArICdcXG4nKTtcbiAgICB3cml0ZUxpbmUoXG4gICAgICBcImltcG9ydCB7IFNjaGVtYSwgU09iamVjdERlZmluaXRpb24sIERhdGVTdHJpbmcsIEJsb2JTdHJpbmcsIEFkZHJlc3MgfSBmcm9tICdqc2ZvcmNlJztcIixcbiAgICApO1xuICAgIHdyaXRlTGluZSgnJyk7XG4gICAgZm9yIChjb25zdCBzb2JqZWN0IG9mIHNvYmplY3RzKSB7XG4gICAgICBjb25zdCB7IG5hbWUsIGZpZWxkcywgY2hpbGRSZWxhdGlvbnNoaXBzIH0gPSBzb2JqZWN0O1xuICAgICAgd3JpdGVMaW5lKGB0eXBlIEZpZWxkcyQke25hbWV9ID0ge2ApO1xuICAgICAgd3JpdGVMaW5lKCcgIC8vJyk7XG4gICAgICBmb3IgKGNvbnN0IHsgbmFtZSwgdHlwZSwgbmlsbGFibGUgfSBvZiBmaWVsZHMpIHtcbiAgICAgICAgY29uc3QgdHNUeXBlID0gZ2V0VFNUeXBlU3RyaW5nKHR5cGUpO1xuICAgICAgICBjb25zdCBvck51bGwgPSBuaWxsYWJsZSA/ICcgfCBudWxsJyA6ICcnO1xuICAgICAgICB3cml0ZUxpbmUoYCAgJHtuYW1lfTogJHt0c1R5cGV9JHtvck51bGx9O2ApO1xuICAgICAgfVxuICAgICAgd3JpdGVMaW5lKCd9OycpO1xuICAgICAgd3JpdGVMaW5lKCcnKTtcbiAgICAgIHdyaXRlTGluZShgdHlwZSBQYXJlbnRSZWZlcmVuY2VzJCR7bmFtZX0gPSB7YCk7XG4gICAgICB3cml0ZUxpbmUoJyAgLy8nKTtcbiAgICAgIGNvbnN0IHBhcmVudFJlZmVyZW5jZXMgPSBnZXRQYXJlbnRSZWZlcmVuY2VzKHNvYmplY3QpO1xuICAgICAgZm9yIChjb25zdCB7XG4gICAgICAgIG5pbGxhYmxlLFxuICAgICAgICBwYXJlbnRTT2JqZWN0LFxuICAgICAgICByZWxhdGlvbnNoaXBOYW1lLFxuICAgICAgfSBvZiBwYXJlbnRSZWZlcmVuY2VzKSB7XG4gICAgICAgIGNvbnN0IG9yTnVsbCA9IG5pbGxhYmxlID8gJyB8IG51bGwnIDogJyc7XG4gICAgICAgIHdyaXRlTGluZShcbiAgICAgICAgICBgICAke3JlbGF0aW9uc2hpcE5hbWV9OiBTT2JqZWN0RGVmaW5pdGlvbiQke3BhcmVudFNPYmplY3R9JHtvck51bGx9O2AsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB3cml0ZUxpbmUoJ307Jyk7XG4gICAgICB3cml0ZUxpbmUoJycpO1xuICAgICAgd3JpdGVMaW5lKGB0eXBlIENoaWxkUmVsYXRpb25zaGlwcyQke25hbWV9ID0ge2ApO1xuICAgICAgd3JpdGVMaW5lKCcgIC8vJyk7XG4gICAgICBmb3IgKGNvbnN0IHtcbiAgICAgICAgZmllbGQsXG4gICAgICAgIGNoaWxkU09iamVjdCxcbiAgICAgICAgcmVsYXRpb25zaGlwTmFtZSxcbiAgICAgIH0gb2YgY2hpbGRSZWxhdGlvbnNoaXBzKSB7XG4gICAgICAgIGlmIChmaWVsZCAmJiBjaGlsZFNPYmplY3QgJiYgcmVsYXRpb25zaGlwTmFtZSAmJiAhL19fYyQvLnRlc3QoZmllbGQpKSB7XG4gICAgICAgICAgd3JpdGVMaW5lKFxuICAgICAgICAgICAgYCAgJHtyZWxhdGlvbnNoaXBOYW1lfTogU09iamVjdERlZmluaXRpb24kJHtjaGlsZFNPYmplY3R9O2AsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgd3JpdGVMaW5lKCd9OycpO1xuICAgICAgd3JpdGVMaW5lKCcnKTtcbiAgICAgIHdyaXRlTGluZShcbiAgICAgICAgYGludGVyZmFjZSBTT2JqZWN0RGVmaW5pdGlvbiQke25hbWV9IGV4dGVuZHMgU09iamVjdERlZmluaXRpb248JyR7bmFtZX0nPiB7XG4gICAgTmFtZTogJyR7bmFtZX0nO1xuICAgIEZpZWxkczogRmllbGRzJCR7bmFtZX07XG4gICAgUGFyZW50UmVmZXJlbmNlczogUGFyZW50UmVmZXJlbmNlcyQke25hbWV9O1xuICAgIENoaWxkUmVsYXRpb25zaGlwczogQ2hpbGRSZWxhdGlvbnNoaXBzJCR7bmFtZX07XG4gIH1gLFxuICAgICAgKTtcbiAgICAgIHdyaXRlTGluZSgnJyk7XG4gICAgfVxuICAgIHdyaXRlTGluZSgnJyk7XG4gICAgd3JpdGVMaW5lKGBleHBvcnQgaW50ZXJmYWNlICR7c2NoZW1hTmFtZX0gZXh0ZW5kcyBTY2hlbWEge2ApO1xuICAgIHdyaXRlTGluZSgnICBTT2JqZWN0czogeycpO1xuICAgIGZvciAoY29uc3QgeyBuYW1lIH0gb2Ygc29iamVjdHMpIHtcbiAgICAgIHdyaXRlTGluZShgICAgICR7bmFtZX06IFNPYmplY3REZWZpbml0aW9uJCR7bmFtZX07YCk7XG4gICAgfVxuICAgIHdyaXRlTGluZSgnICB9OycpO1xuICAgIHdyaXRlTGluZSgnfScpO1xuICAgIG91dC5lbmQoKTtcbiAgfSk7XG59XG5cbmludGVyZmFjZSBHZW5lcmF0b3JDb21tYW5kIGV4dGVuZHMgQ29tbWFuZCB7XG4gIGNvbm5lY3Rpb24/OiBzdHJpbmc7XG4gIHVzZXJuYW1lPzogc3RyaW5nO1xuICBwYXNzd29yZD86IHN0cmluZztcbiAgbG9naW5Vcmw/OiBzdHJpbmc7XG4gIHNhbmRib3g/OiBib29sZWFuO1xuICBvdXRwdXRGaWxlOiBzdHJpbmc7XG4gIGNhY2hlPzogYm9vbGVhbjtcbiAgY2xlYXJDYWNoZT86IGJvb2xlYW47XG59XG5cbi8qKlxuICpcbiAqL1xuZnVuY3Rpb24gcmVhZENvbW1hbmQoKTogR2VuZXJhdG9yQ29tbWFuZCB7XG4gIHJldHVybiBuZXcgQ29tbWFuZCgpXG4gICAgLm9wdGlvbignLXUsIC0tdXNlcm5hbWUgW3VzZXJuYW1lXScsICdTYWxlc2ZvcmNlIHVzZXJuYW1lJylcbiAgICAub3B0aW9uKFxuICAgICAgJy1wLCAtLXBhc3N3b3JkIFtwYXNzd29yZF0nLFxuICAgICAgJ1NhbGVzZm9yY2UgcGFzc3dvcmQgKGFuZCBzZWN1cml0eSB0b2tlbiwgaWYgYXZhaWxhYmxlKScsXG4gICAgKVxuICAgIC5vcHRpb24oXG4gICAgICAnLWMsIC0tY29ubmVjdGlvbiBbY29ubmVjdGlvbl0nLFxuICAgICAgJ0Nvbm5lY3Rpb24gbmFtZSBzdG9yZWQgaW4gY29ubmVjdGlvbiByZWdpc3RyeScsXG4gICAgKVxuICAgIC5vcHRpb24oJy1sLCAtLWxvZ2luVXJsIFtsb2dpblVybF0nLCAnU2FsZXNmb3JjZSBsb2dpbiB1cmwnKVxuICAgIC5vcHRpb24oJy1uLCAtLXNjaGVtYU5hbWUgW3NjaGVtYU5hbWVdJywgJ05hbWUgb2Ygc2NoZW1hIHR5cGUnLCAnTXlTY2hlbWEnKVxuICAgIC5yZXF1aXJlZE9wdGlvbihcbiAgICAgICctbywgLS1vdXRwdXRGaWxlIDxvdXRwdXRGaWxlPicsXG4gICAgICAnR2VuZXJhdGVkIHNjaGVtYSBmaWxlIHBhdGgnLFxuICAgICAgJy4vc2NoZW1hLmQudHMnLFxuICAgIClcbiAgICAub3B0aW9uKCctLXNhbmRib3gnLCAnTG9naW4gdG8gU2FsZXNmb3JjZSBzYW5kYm94JylcbiAgICAub3B0aW9uKFxuICAgICAgJy0tbm8tY2FjaGUnLFxuICAgICAgJ0RvIG5vdCBnZW5lcmF0ZSBjYWNoZSBmaWxlIGZvciBkZXNjcmliZWQgcmVzdWx0IGluIHRtcCBkaXJlY3RvcnknLFxuICAgIClcbiAgICAub3B0aW9uKCctLWNsZWFyQ2FjaGUnLCAnQ2xlYXIgYWxsIGV4aXN0aW5nIGRlc2NyaWJlZCBjYWNoZSBmaWxlcycpXG4gICAgLnZlcnNpb24oVkVSU0lPTilcbiAgICAucGFyc2UocHJvY2Vzcy5hcmd2KSBhcyBHZW5lcmF0b3JDb21tYW5kO1xufVxuXG4vKipcbiAqXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIG1haW4oKSB7XG4gIGNvbnN0IHByb2dyYW0gPSByZWFkQ29tbWFuZCgpO1xuICBjb25zdCBjbGkgPSBuZXcgQ2xpKCk7XG4gIGF3YWl0IGNsaS5jb25uZWN0KHByb2dyYW0pO1xuICBjb25zdCBjb25uID0gY2xpLmdldEN1cnJlbnRDb25uZWN0aW9uKCk7XG4gIGlmICghY29ubi51c2VySW5mbykge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Nhbm5vdCBjb25uZWN0IHRvIFNhbGVzZm9yY2UnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgYXdhaXQgZHVtcFNjaGVtYShcbiAgICBjb25uLFxuICAgIGNvbm4udXNlckluZm8ub3JnYW5pemF0aW9uSWQsXG4gICAgcHJvZ3JhbS5vdXRwdXRGaWxlLFxuICAgIHByb2dyYW0uc2NoZW1hTmFtZSxcbiAgICBwcm9ncmFtLmNhY2hlLFxuICApO1xuICBpZiAocHJvZ3JhbS5jbGVhckNhY2hlKSB7XG4gICAgY29uc29sZS5sb2coJ3JlbW92aW5nIGNhY2hlIGZpbGVzJyk7XG4gICAgYXdhaXQgZnMucmVtb3ZlKGdldENhY2hlRmlsZURpcigpKTtcbiAgfVxuICBjb25zb2xlLmxvZyhgRHVtcGVkIHRvOiAke3Byb2dyYW0ub3V0cHV0RmlsZX1gKTtcbn1cbiJdfQ==